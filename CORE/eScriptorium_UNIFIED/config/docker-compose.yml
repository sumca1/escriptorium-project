name: escriptorium-unified

x-app:
  &app
  build:
    context: ..
  env_file: ./variables.env
  environment:
    - TZ=Asia/Jerusalem
  volumes:
    - ./app/:/usr/src/app/
    - static:/usr/src/app/static
    - media:/usr/src/app/media
  command: /bin/true

services:

  web:
    <<: *app
    command: uwsgi --ini /usr/src/app/uwsgi.ini
    restart: unless-stopped
    expose:
      - 8000
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://nginx:80/login', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      nginx:
        condition: service_started

  channelserver:
    <<: *app
    command: /usr/src/app/entrypoint.sh daphne --bind 0.0.0.0 --port 5000 -v 1 escriptorium.asgi:application
    restart: unless-stopped
    expose:
      - 5000

  # FastAPI service for real-time image processing (Days 1-4)
  fastapi:
    <<: *app
    command: python -m uvicorn fastapi_app.main:app --host 0.0.0.0 --port 8001 --reload
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - PYTHONPATH=/usr/src/app
    depends_on:
      - redis
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  db:
    image: docker.io/library/postgres:15
    restart: unless-stopped
    environment:
      - TZ=Asia/Jerusalem
    volumes:
      - postgres:/var/lib/postgresql/data/
    env_file: variables.env

  redis:
    image: "docker.io/redis:alpine"
    restart: unless-stopped
    environment:
      - TZ=Asia/Jerusalem

  nginx:
    image: registry.gitlab.com/scripta/escriptorium/nginx
    build: ./nginx
    restart: unless-stopped
    environment:
      - SERVERNAME=${DOMAIN:-localhost}
      - TZ=Asia/Jerusalem
    volumes:
      - static:/usr/src/app/static
      - media:/usr/src/app/media
    ports:
      - 8082:80

  celery-main:
    <<: *app
    restart: unless-stopped
    environment:
      - OMP_NUM_THREADS=1
      - TZ=Asia/Jerusalem
    command: "celery -A escriptorium worker -l INFO -E -Ofair --prefetch-multiplier 1 -Q default -c ${CELERY_MAIN_CONC:-10} --max-tasks-per-child=10"

  celery-live:
    <<: *app
    restart: unless-stopped
    command: "celery -A escriptorium worker -l INFO -E -Ofair --prefetch-multiplier 1 -Q live -c ${CELERY_LIVE_CONC:-10} --max-tasks-per-child=10"

  celery-low-priority:
    <<: *app
    restart: unless-stopped
    command: "celery -A escriptorium worker -l INFO -E -Ofair --prefetch-multiplier 1 -Q low-priority -c ${CELERY_LOW_CONC:-10} --max-tasks-per-child=10"

  celery-gpu: &celery-gpu
    <<: *app
    restart: unless-stopped
    environment:
      - KRAKEN_TRAINING_DEVICE=cpu
      - TZ=Asia/Jerusalem
    command: "celery -A escriptorium worker -l INFO -E -Ofair --prefetch-multiplier 1 -Q gpu -c 1 --max-tasks-per-child=1"
    shm_size: '3gb'

  flower:
    image: docker.io/mher/flower
    restart: unless-stopped
    environment:
      - TZ=Asia/Jerusalem
    command: ["celery", "--broker=redis://redis:6379/0", "flower", "--port=5555"]
    ports:
      - 5555:5555

  # Celery Beat scheduler for periodic tasks (health checks, cleanup, etc.)
  celerybeat:
    <<: *app
    restart: unless-stopped
    volumes:
      - ./app/:/usr/src/app/
      - static:/usr/src/app/static
      - media:/usr/src/app/media
    command: celery -E -A escriptorium beat -l INFO

  mail:
    build: ./exim
    restart: unless-stopped
    image: registry.gitlab.com/scripta/escriptorium/mail
    environment:
      - PRIMARY_HOST=${DOMAIN:-localhost}
      - ALLOWED_HOSTS=web ; celery-main ; celery-low-priority; docker0
      - TZ=Asia/Jerusalem
    expose:
      - 25

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.0
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=false
      - TZ=Asia/Jerusalem
    volumes:
      - esdata:/usr/share/elasticsearch/data
    expose:
      - 9200

  # Passim text alignment service (Feature #4)
  passim:
    build:
      context: .
      dockerfile: Dockerfile.passim
    container_name: escriptorium_clean-passim-1
    environment:
      - JAVA_OPTS=-Xmx4g -Xms1g
      - TZ=Asia/Jerusalem
    volumes:
      - passim_data:/passim/data
      - passim_output:/passim/output
      - media:/passim/input:ro  # Read-only access to transcriptions
    ports:
      - "9090:9090"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:9090/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

volumes:
   static:
   media:
   postgres:
   esdata:
   passim_data:
   passim_output:

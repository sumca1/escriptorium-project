{% load i18n %}
{# Enhanced Image Processing with FastAPI #}
<div id="enhance-image-wizard" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-magic mr-2"></i>{% trans "Enhance Images (FastAPI)" %}
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      
      <div class="modal-body">
        <h1 class="sr-only">{% trans "Enhance Images with FastAPI" %} - {% trans "Advanced Image Enhancement Wizard" %}</h1>
        <div class="alert alert-info">
          <i class="fas fa-info-circle mr-2"></i>
          {% trans "Advanced image enhancement using FastAPI backend - 3-4x faster than traditional processing!" %}
        </div>

        <form id="enhance-image-form">
          <div class="form-group">
            <label class="font-weight-bold">{% trans "Processing Type" %}</label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="processType" id="autoProcess" value="auto" checked>
              <label class="form-check-label" for="autoProcess">
                <strong>{% trans "Auto Process (Recommended)" %}</strong><br>
                <small class="text-muted">{% trans "Full pipeline: denoise → deskew → enhance → binarize" %}</small>
              </label>
            </div>
            <div class="form-check mt-2">
              <input class="form-check-input" type="radio" name="processType" id="customProcess" value="custom">
              <label class="form-check-label" for="customProcess">
                <strong>{% trans "Custom Processing" %}</strong><br>
                <small class="text-muted">{% trans "Choose specific operations" %}</small>
              </label>
            </div>
          </div>

          <div id="customOptions" class="mt-3 d-none">
            <div class="card">
              <div class="card-header">
                <strong>{% trans "Select Operations (in order)" %}</strong>
              </div>
              <div class="card-body">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="opDenoise" value="denoise">
                  <label class="form-check-label" for="opDenoise">
                    {% trans "Denoise" %} - <small>{% trans "Remove noise from image" %}</small>
                  </label>
                  <div class="ml-4 mt-1">
                    <label class="small" for="denoiseStrength">{% trans "Strength:" %}</label>
                    <input type="range" class="custom-range" id="denoiseStrength" min="3" max="20" value="10" step="1" aria-label="{% trans 'Denoise strength level' %}">
                    <span id="denoiseValue" class="badge badge-info">10</span>
                  </div>
                </div>

                <div class="form-check mt-3">
                  <input class="form-check-input" type="checkbox" id="opDeskew" value="deskew">
                  <label class="form-check-label" for="opDeskew">
                    {% trans "Deskew" %} - <small>{% trans "Auto-rotate to correct orientation" %}</small>
                  </label>
                </div>

                <div class="form-check mt-3">
                  <input class="form-check-input" type="checkbox" id="opEnhance" value="enhance">
                  <label class="form-check-label" for="opEnhance">
                    {% trans "Enhance Contrast" %} - <small>{% trans "CLAHE enhancement" %}</small>
                  </label>
                  <div class="ml-4 mt-1">
                    <label class="small" for="enhanceClip">{% trans "Clip Limit:" %}</label>
                    <input type="range" class="custom-range" id="enhanceClip" min="1" max="10" value="2" step="0.5" aria-label="{% trans 'Enhancement clip limit' %}">
                    <span id="enhanceValue" class="badge badge-info">2.0</span>
                  </div>
                </div>

                <div class="form-check mt-3">
                  <input class="form-check-input" type="checkbox" id="opBinarize" value="binarize">
                  <label class="form-check-label" for="opBinarize">
                    {% trans "Binarize" %} - <small>{% trans "Convert to black and white" %}</small>
                  </label>
                  <div class="ml-4 mt-1">
                    <label class="small" for="binarizeMethod">{% trans "Method:" %}</label>
                    <select class="form-control form-control-sm" id="binarizeMethod" aria-label="{% trans 'Binarization method selection' %}">
                      <option value="otsu">{% trans "Otsu (Automatic)" %}</option>
                      <option value="adaptive_mean" selected>{% trans "Adaptive Mean" %}</option>
                      <option value="adaptive_gaussian">{% trans "Adaptive Gaussian" %}</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="form-group mt-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="replaceOriginal" name="replaceOriginal">
              <label class="form-check-label" for="replaceOriginal">
                {% trans "Replace original images" %}
              </label>
              <small class="form-text text-muted">
                {% trans "If unchecked, creates new images with '_enhanced' suffix" %}
              </small>
            </div>
          </div>

          <div id="enhanceProgress" class="mt-3 d-none">
            <div class="progress">
              <div id="enhanceProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                   role="progressbar" style="width: 0%" aria-label="{% trans 'Image enhancement progress' %}" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <div class="mt-2">
              <small id="enhanceStatus" class="text-muted">{% trans "Starting..." %}</small>
            </div>
          </div>

          <div id="enhanceResults" class="mt-3 d-none">
            <div class="alert alert-success">
              <i class="fas fa-check-circle mr-2"></i>
              <span id="enhanceResultMessage"></span>
            </div>
          </div>

          <div id="enhanceError" class="mt-3 d-none">
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle mr-2"></i>
              <span id="enhanceErrorMessage"></span>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          {% trans "Cancel" %}
        </button>
        <button type="button" id="startEnhance" class="btn btn-primary">
          <i class="fas fa-play mr-2"></i>{% trans "Start Enhancement" %}
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Enhanced Image Processing Logic
if (typeof $ !== 'undefined' && typeof jQuery !== 'undefined') {
(function() {
  'use strict';

  // Toggle custom options
  $('input[name="processType"]').on('change', function() {
    if ($(this).val() === 'custom') {
      $('#customOptions').slideDown();
    } else {
      $('#customOptions').slideUp();
    }
  });

  // Update slider values
  $('#denoiseStrength').on('input', function() {
    $('#denoiseValue').text($(this).val());
  });

  $('#enhanceClip').on('input', function() {
    $('#enhanceValue').text($(this).val());
  });

  // Start Enhancement
  $('#startEnhance').on('click', async function() {
    const button = $(this);
    const processType = $('input[name="processType"]:checked').val();
    const replaceOriginal = $('#replaceOriginal').is(':checked');
    
    // Disable button and show progress
    button.prop('disabled', true);
    $('#enhanceProgress').show();
    $('#enhanceResults').hide();
    $('#enhanceError').hide();

    // Get selected images
    const selectedCards = $('.card.selected');
    if (selectedCards.length === 0) {
      showError('{% trans "Please select at least one image" %}');
      button.prop('disabled', false);
      return;
    }

    try {
      const imageIds = selectedCards.map(function() {
        return $(this).attr('id').replace('image-card-', '');
      }).get();

      updateProgress(0, `{% trans "Processing" %} 0/${imageIds.length} {% trans "images" %}...`);

      // Process images
      let processed = 0;
      for (const imageId of imageIds) {
        if (processType === 'auto') {
          await processAutoEnhance(imageId, replaceOriginal);
        } else {
          await processCustomEnhance(imageId, replaceOriginal);
        }
        
        processed++;
        const percent = Math.round((processed / imageIds.length) * 100);
        updateProgress(percent, `{% trans "Processed" %} ${processed}/${imageIds.length} {% trans "images" %}`);
      }

      // Success
      showSuccess(`{% trans "Successfully enhanced" %} ${processed} {% trans "images" %}!`);
      
      // Reload images after 2 seconds
      setTimeout(() => {
        location.reload();
      }, 2000);

    } catch (error) {
      console.error('Enhancement error:', error);
      showError(error.message || '{% trans "Enhancement failed" %}');
    } finally {
      button.prop('disabled', false);
    }
  });

  async function processAutoEnhance(imageId, replace) {
    const formData = new FormData();
    
    // Get image data
    const imageUrl = $(`#image-card-${imageId} img`).attr('src');
    const response = await fetch(imageUrl);
    const blob = await response.blob();
    formData.append('file', blob, 'image.jpg');

    // Call FastAPI endpoint
    const result = await fetch('/api/fastapi/auto-process/?return_json=true', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': getCookie('csrftoken')
      }
    });

    if (!result.ok) {
      throw new Error(`HTTP ${result.status}: ${result.statusText}`);
    }

    const data = await result.json();
    
    // Save enhanced image
    if (replace) {
      await saveEnhancedImage(imageId, data.image);
    } else {
      await createNewImage(imageId, data.image);
    }

    return data;
  }

  async function processCustomEnhance(imageId, replace) {
    const operations = [];
    
    if ($('#opDenoise').is(':checked')) {
      operations.push({
        type: 'denoise',
        params: { strength: parseInt($('#denoiseStrength').val()) }
      });
    }
    
    if ($('#opDeskew').is(':checked')) {
      operations.push({ type: 'deskew' });
    }
    
    if ($('#opEnhance').is(':checked')) {
      operations.push({
        type: 'enhance',
        params: { clip_limit: parseFloat($('#enhanceClip').val()) }
      });
    }
    
    if ($('#opBinarize').is(':checked')) {
      operations.push({
        type: 'binarize',
        params: { method: $('#binarizeMethod').val() }
      });
    }

    // Execute operations sequentially
    let imageData = await getImageBlob(imageId);
    
    for (const op of operations) {
      imageData = await executeOperation(op, imageData);
    }

    // Save result
    if (replace) {
      await saveEnhancedImage(imageId, imageData);
    } else {
      await createNewImage(imageId, imageData);
    }
  }

  async function executeOperation(operation, imageBlob) {
    const formData = new FormData();
    formData.append('file', imageBlob, 'image.jpg');

    let url = `/api/fastapi/${operation.type}/`;
    if (operation.params) {
      const params = new URLSearchParams(operation.params);
      url += `?${params}&return_json=true`;
    } else {
      url += '?return_json=true';
    }

    const response = await fetch(url, {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': getCookie('csrftoken')
      }
    });

    if (!response.ok) {
      throw new Error(`${operation.type} failed: ${response.statusText}`);
    }

    const data = await response.json();
    return data.image; // base64 image
  }

  async function getImageBlob(imageId) {
    const imageUrl = $(`#image-card-${imageId} img`).attr('src');
    const response = await fetch(imageUrl);
    return await response.blob();
  }

  async function saveEnhancedImage(imageId, base64Image) {
    // Convert base64 to blob and update the image
    const blob = await fetch(`data:image/png;base64,${base64Image}`).then(r => r.blob());
    
    // Update via Django API
    const formData = new FormData();
    formData.append('image', blob, 'enhanced.png');
    
    const response = await fetch(`/api/parts/${imageId}/`, {
      method: 'PATCH',
      body: formData,
      headers: {
        'X-CSRFToken': getCookie('csrftoken')
      }
    });

    if (!response.ok) {
      throw new Error('Failed to save enhanced image');
    }
  }

  async function createNewImage(imageId, base64Image) {
    // Create new image part with enhanced version
    const blob = await fetch(`data:image/png;base64,${base64Image}`).then(r => r.blob());
    
    const formData = new FormData();
    formData.append('image', blob, 'enhanced.png');
    formData.append('document', DOCUMENT_ID);
    formData.append('name', `Enhanced_${imageId}`);
    
    const response = await fetch(`/api/parts/`, {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': getCookie('csrftoken')
      }
    });

    if (!response.ok) {
      throw new Error('Failed to create new image');
    }
  }

  function updateProgress(percent, message) {
    $('#enhanceProgressBar').css('width', percent + '%').text(percent + '%');
    $('#enhanceStatus').text(message);
  }

  function showSuccess(message) {
    $('#enhanceProgress').hide();
    $('#enhanceResultMessage').text(message);
    $('#enhanceResults').show();
  }

  function showError(message) {
    $('#enhanceProgress').hide();
    $('#enhanceErrorMessage').text(message);
    $('#enhanceError').show();
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
})();
} else {
  console.error('jQuery not loaded - enhance image wizard will not work');
}
</script>

/*
 * ATTENTION: The "eval" devtool has been used (maybe by default in mode: "development").
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
/******/ (() => { // webpackBootstrap
/******/ 	var __webpack_modules__ = ({

/***/ "./css/escriptorium.css":
/*!******************************!*\
  !*** ./css/escriptorium.css ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n// extracted by mini-css-extract-plugin\n\n\n//# sourceURL=webpack://escriptorium/./css/escriptorium.css?");

/***/ }),

/***/ "./css/rtl.css":
/*!*********************!*\
  !*** ./css/rtl.css ***!
  \*********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n// extracted by mini-css-extract-plugin\n\n\n//# sourceURL=webpack://escriptorium/./css/rtl.css?");

/***/ }),

/***/ "./css/ttb.css":
/*!*********************!*\
  !*** ./css/ttb.css ***!
  \*********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n// extracted by mini-css-extract-plugin\n\n\n//# sourceURL=webpack://escriptorium/./css/ttb.css?");

/***/ }),

/***/ "./node_modules/@recogito/annotorious/dist/annotorious.min.css":
/*!*********************************************************************!*\
  !*** ./node_modules/@recogito/annotorious/dist/annotorious.min.css ***!
  \*********************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n// extracted by mini-css-extract-plugin\n\n\n//# sourceURL=webpack://escriptorium/./node_modules/@recogito/annotorious/dist/annotorious.min.css?");

/***/ }),

/***/ "./node_modules/@recogito/recogito-js/dist/recogito.min.css":
/*!******************************************************************!*\
  !*** ./node_modules/@recogito/recogito-js/dist/recogito.min.css ***!
  \******************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n// extracted by mini-css-extract-plugin\n\n\n//# sourceURL=webpack://escriptorium/./node_modules/@recogito/recogito-js/dist/recogito.min.css?");

/***/ }),

/***/ "./src/ajax.js":
/*!*********************!*\
  !*** ./src/ajax.js ***!
  \*********************/
/***/ (() => {

eval("var csrftoken = Cookies.get(\"csrftoken\");\r\nfunction csrfSafeMethod(method) {\r\n    // these HTTP methods do not require CSRF protection\r\n    return /^(GET|HEAD|OPTIONS|TRACE)$/.test(method);\r\n}\r\n$.ajaxSetup({\r\n    beforeSend: function (xhr, settings) {\r\n        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {\r\n            xhr.setRequestHeader(\"X-CSRFToken\", csrftoken);\r\n        }\r\n    },\r\n});\r\n\n\n//# sourceURL=webpack://escriptorium/./src/ajax.js?");

/***/ }),

/***/ "./src/align_form.js":
/*!***************************!*\
  !*** ./src/align_form.js ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   bootAlignForm: () => (/* binding */ bootAlignForm)\n/* harmony export */ });\n\r\nfunction bootAlignForm() {\r\n    // don't allow beam size and max offset both to be non-zero\r\n    const form = document.getElementById(\"process-part-form-align\");\r\n    const beamSizeField = form.querySelector(\"#id_beam_size\");\r\n    const maxOffsetField = form.querySelector(\"#id_max_offset\");\r\n    beamSizeField.addEventListener(\"input\", (e) => {\r\n        if (\r\n            e.currentTarget.value &&\r\n            e.currentTarget.value !== \"\" &&\r\n            e.currentTarget.value !== \"0\"\r\n        ) {\r\n            maxOffsetField.setAttribute(\"disabled\", \"true\");\r\n            maxOffsetField.setAttribute(\"value\", \"\");\r\n            maxOffsetField.value = \"\";\r\n        } else {\r\n            maxOffsetField.removeAttribute(\"disabled\");\r\n        }\r\n    });\r\n    maxOffsetField.addEventListener(\"input\", (e) => {\r\n        if (\r\n            e.currentTarget.value &&\r\n            e.currentTarget.value !== \"\" &&\r\n            e.currentTarget.value !== \"0\"\r\n        ) {\r\n            beamSizeField.setAttribute(\"disabled\", \"true\");\r\n            beamSizeField.setAttribute(\"value\", \"\");\r\n            beamSizeField.value = \"\";\r\n        } else {\r\n            beamSizeField.removeAttribute(\"disabled\");\r\n        }\r\n    });\r\n    // ensure fields re-enabled on modal close\r\n    const reEnableFields = () => {\r\n        maxOffsetField.removeAttribute(\"disabled\");\r\n        beamSizeField.removeAttribute(\"disabled\");\r\n    };\r\n    form.querySelector('button[data-dismiss=\"modal\"]').addEventListener(\r\n        \"click\",\r\n        reEnableFields,\r\n    );\r\n    form.querySelector('button[type=\"submit\"]').addEventListener(\r\n        \"click\",\r\n        reEnableFields,\r\n    );\r\n}\r\n\n\n//# sourceURL=webpack://escriptorium/./src/align_form.js?");

/***/ }),

/***/ "./src/document_form.js":
/*!******************************!*\
  !*** ./src/document_form.js ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   bootDocumentForm: () => (/* binding */ bootDocumentForm)\n/* harmony export */ });\n\r\nfunction bootDocumentForm(scripts) {\r\n    setupFormSet(document.getElementById(\"document-form\"));\r\n\r\n    // link tabs\r\n    var hash = window.location.hash;\r\n    hash && $('div.nav.nav-tabs a[href=\"' + hash + '\"]').tab(\"show\");\r\n    $(\"div.nav.nav-tabs a\").click(function (e) {\r\n        if (!$(this).is(\".disabled\")) {\r\n            $(this).tab(\"show\");\r\n            var scrollmem = $(\"body\").scrollTop();\r\n            window.location.hash = this.hash;\r\n        }\r\n    });\r\n\r\n    // When selecting a rtl script, select rtl read direction\r\n    // flash shortly the read direction to tell the user when it changed\r\n    $(\"#id_main_script\").on(\"change\", function (ev) {\r\n        let dir = scripts[ev.target.value];\r\n        if (dir == \"horizontal-rl\") {\r\n            if ($(\"#id_read_direction\").val() !== \"rtl\") {\r\n                $(\"#id_read_direction\")\r\n                    .val(\"rtl\")\r\n                    .addClass(\"is-valid\")\r\n                    .removeClass(\"is-valid\", 1000);\r\n            }\r\n        } else {\r\n            if ($(\"#id_read_direction\").val() !== \"ltr\") {\r\n                $(\"#id_read_direction\")\r\n                    .val(\"ltr\")\r\n                    .addClass(\"is-valid\")\r\n                    .removeClass(\"is-valid\", 1000);\r\n            }\r\n        }\r\n    });\r\n}\r\n\n\n//# sourceURL=webpack://escriptorium/./src/document_form.js?");

/***/ }),

/***/ "./src/formsets.js":
/*!*************************!*\
  !*** ./src/formsets.js ***!
  \*************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   setupFormSet: () => (/* binding */ setupFormSet)\n/* harmony export */ });\n\r\n\r\n/*\r\n * Automatically create new rows for formsets when the last line is filled,\r\n * requires a parent element with the 'js-formset-row' class.\r\n * Also deals with switching the delete button style and hidden input value,\r\n * requires a hidden -DELETE input and a button with the 'js-formset-delete' class\r\n * and a for= attribute pointing to the input.\r\n */\r\nfunction setupFormSet(form) {\r\n    // delete a row\r\n    form.querySelectorAll(\".js-formset-delete\").forEach((e) =>\r\n        e.addEventListener(\"mouseup\", function (ev) {\r\n            var btn = ev.target;\r\n            var input = document.getElementById(btn.attributes.for.value);\r\n            if (input.value == \"on\") {\r\n                btn.classList.add(\"btn-outline-secondary\");\r\n                btn.classList.remove(\"btn-danger\");\r\n                input.value = \"\";\r\n            } else {\r\n                btn.classList.add(\"btn-danger\");\r\n                btn.classList.remove(\"btn-outline-secondary\");\r\n                input.value = \"on\";\r\n            }\r\n        }),\r\n    );\r\n\r\n    // the browser might save the state of the delete box if its not posted\r\n    // so we need to check its state on startup and change the button color accordingly\r\n    var btns = document.getElementsByClassName(\"js-formset-delete\");\r\n    for (var i = 0; i < btns.length; i++) {\r\n        var btn = btns.item(i);\r\n        var input = document.getElementById(btn.attributes.for.value);\r\n        if (input.value == \"on\") {\r\n            btn.classList.add(\"btn-danger\");\r\n            btn.classList.remove(\"btn-outline-secondary\");\r\n        }\r\n    }\r\n\r\n    // add a formset row if we add data in the empty one\r\n    form.addEventListener(\"change\", function (ev) {\r\n        // need to use closest to work with nested formsets\r\n        let input = ev.target;\r\n        let row = input.closest(\".js-formset-row\");\r\n        if (row === null) return;\r\n        // if it is the last row, we add a new one\r\n        // :scope allows to only select direct children to deal with nested formsets\r\n        let rows = row.parentNode.querySelectorAll(\":scope > .js-formset-row\");\r\n        if (row == rows[rows.length - 1] && ev.target.value) {\r\n            let prefix = input.id\r\n                .split(\"-\")\r\n                .splice(0, input.id.split(\"-\").length - 2)\r\n                .join(\"-\")\r\n                .substr(3);\r\n            let totalInput = form.querySelector(\r\n                \"#id_\" + prefix + \"-TOTAL_FORMS\",\r\n            );\r\n            let total = parseInt(totalInput.value);\r\n            totalInput.value = total + 1;\r\n            let newRow = row.cloneNode(true);\r\n            row.parentNode.appendChild(newRow);\r\n            newRow.querySelectorAll(\"input,select\").forEach((e) => {\r\n                e.id = e.id.replace(/-\\d+-(\\D+$)/, \"-\" + total + \"-$1\");\r\n                e.name = e.name.replace(/-\\d+-(\\D+$)/, \"-\" + total + \"-$1\");\r\n                if (e.type != \"hidden\") e.value = \"\";\r\n                if (e.nodeName == \"SELECT\")\r\n                    e.querySelectorAll(\"option\")[0].selected = true;\r\n            });\r\n        }\r\n    });\r\n}\r\n\n\n//# sourceURL=webpack://escriptorium/./src/formsets.js?");

/***/ }),

/***/ "./src/help.js":
/*!*********************!*\
  !*** ./src/help.js ***!
  \*********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   bootHelp: () => (/* binding */ bootHelp)\n/* harmony export */ });\nfunction bootHelp() {\r\n    var closed = userProfile.get(\"closedHelps\") || [];\r\n\r\n    let clBtns = document.querySelectorAll(\".help-text .close\");\r\n    clBtns.forEach((e) =>\r\n        e.addEventListener(\"click\", function (ev) {\r\n            let btn = ev.target.closest(\"button\");\r\n            let alert = btn.parentNode;\r\n            let container = alert.parentNode;\r\n            if (!closed) closed = [];\r\n            if (alert.getAttribute(\"id\")) {\r\n                closed.push(alert.getAttribute(\"id\"));\r\n                userProfile.set(\"closedHelps\", closed);\r\n            }\r\n            alert.style.display = \"none\";\r\n        }),\r\n    );\r\n\r\n    let btns = document.querySelectorAll(\"button.help\");\r\n    btns.forEach((e) =>\r\n        e.addEventListener(\"click\", function (ev) {\r\n            let btn = ev.target.closest(\"button\");\r\n            let container = btn.parentNode;\r\n            let helpText = container.querySelector(\".alert.help-text\");\r\n            let helpIndex = closed.indexOf(container.getAttribute(\"id\"));\r\n            if (window.getComputedStyle(helpText).display == \"none\") {\r\n                // open\r\n                if (helpIndex != -1) closed.splice(helpIndex, 1);\r\n                container.querySelector(\".alert.help-text\").style.display =\r\n                    \"block\";\r\n            } else {\r\n                // close\r\n                if (helpIndex == -1) closed.push(container.getAttribute(\"id\"));\r\n                container.querySelector(\".alert.help-text\").style.display =\r\n                    \"none\";\r\n            }\r\n            userProfile.set(\"closedHelps\", closed);\r\n        }),\r\n    );\r\n\r\n    if (closed) {\r\n        closed.forEach(function (e, i) {\r\n            let help = document.querySelector(\".help-text#\" + e);\r\n            if (help) help.style.display = \"none\";\r\n        });\r\n    }\r\n}\r\n\n\n//# sourceURL=webpack://escriptorium/./src/help.js?");

/***/ }),

/***/ "./src/image_cards.js":
/*!****************************!*\
  !*** ./src/image_cards.js ***!
  \****************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   bootImageCards: () => (/* binding */ bootImageCards)\n/* harmony export */ });\n\r\n\r\nvar DOCUMENT_ID;\r\nvar API;\r\n\r\nDropzone.autoDiscover = false;\r\nvar g_dragged = null; // Note: chrome doesn't understand dataTransfer very well\r\nvar lastSelected = null;\r\n\r\nfunction openWizard(proc) {\r\n    var selected_num = partCard.getSelectedPks().length;\r\n\r\n    if (!proc.startsWith(\"import\") && selected_num < 1) {\r\n        alert(\"Select at least one image.\");\r\n        return;\r\n    }\r\n    // update selected count\r\n    $(\"#selected-num\", \"#\" + proc + \"-wizard\").text(selected_num);\r\n\r\n    // Reset the form\r\n    $(\".process-part-form\", \"#\" + proc + \"-wizard\")\r\n        .get(0)\r\n        .reset();\r\n\r\n    // initialize transcription field with user's last edited transcription\r\n    let itrans = userProfile.get(\"initialTranscriptions\");\r\n    if (itrans && itrans[DOCUMENT_ID]) {\r\n        $(\"#process-part-form-export #id_transcription\").val(\r\n            itrans[DOCUMENT_ID],\r\n        );\r\n        $(\"#process-part-form-train #id_transcription\").val(\r\n            itrans[DOCUMENT_ID],\r\n        );\r\n    }\r\n\r\n    // initialize export format with user's last selected format\r\n    let export_format = userProfile.get(\"exportFormat\");\r\n    if (export_format) {\r\n        $(\"#process-part-form-export #id_file_format\").val(export_format);\r\n    }\r\n\r\n    $(\"#\" + proc + \"-wizard\").modal(\"show\");\r\n}\r\n\r\nclass partCard {\r\n    constructor(part, cpuMinutesLeft, showConfidenceViz) {\r\n        this.pk = part.pk;\r\n        this.order = part.order;\r\n        this.name = part.name;\r\n        this.title = part.title;\r\n        this.typology = part.typology;\r\n        this.image = part.image;\r\n        this.filename = part.filename;\r\n        this.image_file_size = part.image_file_size;\r\n        this.workflow = part.workflow;\r\n        this.task_ids = {}; // helps preventing card status race conditions\r\n        this.progress = part.transcription_progress;\r\n        this.locked = false;\r\n        this.avgConfidence = part.max_avg_confidence;\r\n\r\n        this.api = API.part.replace(\"{part_pk}\", this.pk);\r\n\r\n        var $new = $(\".card\", \"#card-template\").clone();\r\n        this.$element = $new;\r\n        this.domElement = this.$element.get(0);\r\n\r\n        this.selectButton = $(\".js-card-select-hdl\", $new);\r\n        this.deleteButton = $(\".js-card-delete\", $new);\r\n        this.dropAfter = $(\".js-drop\", \"#card-template\").clone();\r\n\r\n        // fill template\r\n        $new.attr(\"id\", $new.attr(\"id\").replace(\"{pk}\", this.pk));\r\n        this.updateThumbnail();\r\n        $(\"img.card-img-top\", $new).attr(\r\n            \"title\",\r\n            this.title +\r\n                \" (\" +\r\n                this.image_file_size +\r\n                \" bytes)\" +\r\n                \"\\n<\" +\r\n                this.filename +\r\n                \">\",\r\n        );\r\n\r\n        $new.attr(\"draggable\", true);\r\n        $(\"img\", $new).attr(\"draggable\", false);\r\n        $(\"img\", $new).attr(\"selectable\", false);\r\n        // disable dragging when over input because firefox gets confused\r\n        $(\"input\", this.$element)\r\n            .on(\r\n                \"mouseover\",\r\n                $.proxy(function (ev) {\r\n                    this.$element.attr(\"draggable\", false);\r\n                }, this),\r\n            )\r\n            .on(\r\n                \"mouseout\",\r\n                $.proxy(function (ev) {\r\n                    this.$element.attr(\"draggable\", true);\r\n                }, this),\r\n            );\r\n\r\n        // add to the dom\r\n        $(\"#cards-container\").append($new);\r\n        $(\"#cards-container\").append(this.dropAfter);\r\n\r\n        // workflow icons & progress\r\n        this.editButton = $(\".js-edit\", this.$element);\r\n        this.cancelTasksButton = $(\".js-cancel\", this.$element);\r\n        this.convertIcon = $(\".js-compressing\", this.$element);\r\n        this.segmentedButton = $(\".js-segmented\", this.$element);\r\n        this.transcribeButton = $(\".js-trans-progress\", this.$element);\r\n        this.alignButton = $(\".js-align\", this.$element);\r\n        this.progressBar = $(\".progress-bar\", this.transcribeButton);\r\n        this.progressBar.css(\"width\", this.progress + \"%\");\r\n        this.progressBar.text(this.progress + \"%\");\r\n        this.updateWorkflowIcons();\r\n        var url = \"/document/\" + DOCUMENT_ID + \"/part/\" + this.pk + \"/edit/\";\r\n\r\n        // show avg confidence on the card\r\n        var avgConfidenceElement = this.progressBar;\r\n        if (this.avgConfidence && showConfidenceViz) {\r\n            avgConfidenceElement.attr(\r\n                \"title\",\r\n                `Confidence: ${(this.avgConfidence * 100).toFixed(1)}%`,\r\n            );\r\n\r\n            const hue = Math.pow(this.avgConfidence, 4) * 120;\r\n            avgConfidenceElement.css(\r\n                \"background-color\",\r\n                `hsl(${hue}, 100%, 50%, 50%)`,\r\n            );\r\n        }\r\n\r\n        this.editButton.click(function (ev) {\r\n            document.location.replace(url);\r\n        });\r\n        this.cancelTasksButton.click(\r\n            $.proxy(function (ev) {\r\n                if (\r\n                    ![\"ongoing\", \"pending\"].includes(this.workflow[\"align\"]) ||\r\n                    window.confirm(\r\n                        \"This will stop ALL alignment tasks on this document. Are you sure you want to stop alignment?\",\r\n                    )\r\n                ) {\r\n                    this.cancelTasks();\r\n                }\r\n            }, this),\r\n        );\r\n\r\n        if (cpuMinutesLeft !== \"False\") {\r\n            this.segmentedButton.click(\r\n                $.proxy(function (ev) {\r\n                    this.select();\r\n                    partCard.refreshSelectedCount();\r\n                    openWizard(\"segment\");\r\n                }, this),\r\n            );\r\n            this.transcribeButton.click(\r\n                $.proxy(function (ev) {\r\n                    this.select();\r\n                    partCard.refreshSelectedCount();\r\n                    openWizard(\"transcribe\");\r\n                }, this),\r\n            );\r\n            if (this.alignButton) {\r\n                this.alignButton.click(\r\n                    $.proxy(function (ev) {\r\n                        this.select();\r\n                        partCard.refreshSelectedCount();\r\n                        openWizard(\"align\");\r\n                    }, this),\r\n                );\r\n            }\r\n        }\r\n\r\n        this.index = $(\".card\", \"#cards-container\").index(this.$element);\r\n        // save a reference to this object in the card dom element\r\n        $new.data(\"partCard\", this);\r\n\r\n        // add the image element to the lazy loader\r\n        addImageToLoader($new);\r\n\r\n        this.defaultColor = this.$element.css(\"color\");\r\n\r\n        //************* events **************\r\n        this.selectButton.on(\r\n            \"click\",\r\n            $.proxy(function (ev) {\r\n                if (ev.shiftKey) {\r\n                    if (lastSelected) {\r\n                        var cards = partCard.getRange(\r\n                            lastSelected.index,\r\n                            this.index,\r\n                        );\r\n                        cards.each(function (i, el) {\r\n                            $(el).data(\"partCard\").select();\r\n                        });\r\n                    }\r\n                } else {\r\n                    this.toggleSelect();\r\n                }\r\n                partCard.refreshSelectedCount();\r\n            }, this),\r\n        );\r\n\r\n        this.deleteButton.on(\r\n            \"click\",\r\n            $.proxy(function (ev) {\r\n                if (!confirm(\"Do you really want to delete this image?\")) {\r\n                    return;\r\n                }\r\n                this.delete();\r\n                partCard.refreshSelectedCount();\r\n            }, this),\r\n        );\r\n\r\n        this.$element.on(\r\n            \"dblclick\",\r\n            $.proxy(function (ev) {\r\n                this.toggleSelect();\r\n                partCard.refreshSelectedCount();\r\n            }, this),\r\n        );\r\n\r\n        // drag'n'drop\r\n        this.$element.on(\r\n            \"dragstart\",\r\n            $.proxy(function (ev) {\r\n                if (this.locked) return;\r\n                ev.originalEvent.dataTransfer.setData(\r\n                    \"text/card-id\",\r\n                    ev.target.id,\r\n                );\r\n                g_dragged = ev.target.id; // chrome gets confused with dataTransfer, so we use a global\r\n                $(\".js-drop\").addClass(\"drop-target\");\r\n            }, this),\r\n        );\r\n        this.$element.on(\r\n            \"dragend\",\r\n            $.proxy(function (ev) {\r\n                $(\".js-drop\").removeClass(\"drop-target\");\r\n            }, this),\r\n        );\r\n    }\r\n\r\n    inQueue() {\r\n        return (\r\n            (this.workflow[\"convert\"] == \"pending\" ||\r\n                this.workflow[\"segment\"] == \"pending\" ||\r\n                this.workflow[\"transcribe\"] == \"pending\" ||\r\n                this.workflow[\"align\"] == \"pending\") &&\r\n            !this.working()\r\n        );\r\n    }\r\n\r\n    working() {\r\n        return (\r\n            this.workflow[\"convert\"] == \"ongoing\" ||\r\n            this.workflow[\"segment\"] == \"ongoing\" ||\r\n            this.workflow[\"transcribe\"] == \"ongoing\" ||\r\n            this.workflow[\"align\"] == \"ongoing\"\r\n        );\r\n    }\r\n\r\n    isCancelable() {\r\n        const workflows = [\r\n            this.workflow[\"align\"],\r\n            this.workflow[\"segment\"],\r\n            this.workflow[\"transcribe\"],\r\n        ];\r\n        return workflows.some((workflow) =>\r\n            [\"ongoing\", \"pending\"].includes(workflow),\r\n        );\r\n    }\r\n\r\n    updateThumbnail() {\r\n        let uri,\r\n            img = $(\"img.card-img-top\", this.$element);\r\n\r\n        if (\r\n            this.image.thumbnails &&\r\n            this.image.thumbnails[\"card\"] != undefined\r\n        ) {\r\n            uri = this.image.thumbnails[\"card\"];\r\n        } else {\r\n            uri = this.image.uri;\r\n        }\r\n\r\n        if (img.attr(\"src\")) img.attr(\"src\", uri);\r\n        img.attr(\"data-src\", uri);\r\n    }\r\n\r\n    updateWorkflowIcons() {\r\n        var map = [\r\n            [\"convert\", this.convertIcon],\r\n            [\"segment\", this.segmentedButton],\r\n            [\"transcribe\", this.transcribeButton],\r\n            [\"align\", this.alignButton],\r\n        ];\r\n        for (var i = 0; i < map.length; i++) {\r\n            var proc = map[i][0],\r\n                btn = map[i][1];\r\n            if (btn && this.workflow[proc] == undefined) {\r\n                btn.removeClass(\"pending\")\r\n                    .removeClass(\"ongoing\")\r\n                    .removeClass(\"error\")\r\n                    .removeClass(\"done\");\r\n                btn.attr(\"title\", btn.data(\"title\"));\r\n            } else if (btn) {\r\n                btn.removeClass(\"pending\")\r\n                    .removeClass(\"ongoing\")\r\n                    .removeClass(\"error\")\r\n                    .removeClass(\"done\");\r\n                btn.addClass(this.workflow[proc]);\r\n                btn.attr(\r\n                    \"title\",\r\n                    btn.data(\"title\") + \" (\" + this.workflow[proc] + \")\",\r\n                );\r\n            }\r\n        }\r\n\r\n        if (this.inQueue() || this.working()) {\r\n            this.lock();\r\n        } else {\r\n            this.unlock();\r\n        }\r\n\r\n        if (this.isCancelable()) {\r\n            this.cancelTasksButton.show();\r\n        } else {\r\n            this.cancelTasksButton.hide();\r\n        }\r\n    }\r\n\r\n    remove() {\r\n        this.dropAfter.remove();\r\n        this.$element.remove();\r\n    }\r\n\r\n    select(scroll = true) {\r\n        if (this.locked) return;\r\n        lastSelected = this;\r\n        this.$element.addClass(\"bg-dark\");\r\n        this.$element.css({ color: \"white\" });\r\n        $(\"i\", this.selectButton).removeClass(\"fa-square\");\r\n        $(\"i\", this.selectButton).addClass(\"fa-check-square\");\r\n        if (scroll) this.$element.get(0).scrollIntoView();\r\n        this.selected = true;\r\n    }\r\n    unselect() {\r\n        lastSelected = null;\r\n        this.$element.removeClass(\"bg-dark\");\r\n        this.$element.css({ color: this.defaultColor });\r\n        $(\"i\", this.selectButton).removeClass(\"fa-check-square\");\r\n        $(\"i\", this.selectButton).addClass(\"fa-square\");\r\n        this.selected = false;\r\n    }\r\n    toggleSelect() {\r\n        if (this.selected) this.unselect();\r\n        else this.select();\r\n    }\r\n\r\n    lock() {\r\n        this.locked = true;\r\n        this.$element.addClass(\"locked\");\r\n        this.$element.attr(\"draggable\", false);\r\n    }\r\n    unlock() {\r\n        this.locked = false;\r\n        this.$element.removeClass(\"locked\");\r\n        this.$element.attr(\"draggable\", true);\r\n    }\r\n\r\n    moveTo(index, upload) {\r\n        if (upload === undefined) upload = true;\r\n        // store the previous index in case of error\r\n        this.previousIndex = this.index;\r\n        var target = $(\"#cards-container .js-drop\")[index];\r\n        this.$element.insertAfter(target);\r\n        this.dropAfter.insertAfter(this.$element); // drag the droppable zone with it\r\n        if (this.previousIndex < index) {\r\n            index--;\r\n        } // because the dragged card takes a room\r\n        if (upload) {\r\n            $.post(this.api + \"move/\", {\r\n                index: index,\r\n            })\r\n                .done(\r\n                    $.proxy(function (data) {\r\n                        this.previousIndex = null;\r\n                    }, this),\r\n                )\r\n                .fail(\r\n                    $.proxy(function (data) {\r\n                        this.moveTo(this.previousIndex, false);\r\n                        // show errors\r\n                        console.log(\"Something went wrong :(\", data);\r\n                    }, this),\r\n                )\r\n                .always(\r\n                    $.proxy(function () {\r\n                        this.unlock();\r\n                    }, this),\r\n                );\r\n        }\r\n        this.index = index;\r\n    }\r\n\r\n    cancelTasks() {\r\n        $.post(this.api + \"cancel/\", {})\r\n            .done(\r\n                $.proxy(function (data) {\r\n                    if (data.workflow.align !== this.workflow.align) {\r\n                        // update alignment workflow for all affected parts\r\n                        $(\"#cards-container .card\").each(function (i, el) {\r\n                            let ic = $(el).data(\"partCard\");\r\n                            if (ic.workflow.align === \"ongoing\") {\r\n                                ic.workflow = data.workflow;\r\n                                ic.updateWorkflowIcons();\r\n                            }\r\n                        });\r\n                    } else {\r\n                        this.workflow = data.workflow;\r\n                        this.updateWorkflowIcons();\r\n                    }\r\n                }, this),\r\n            )\r\n            .fail(\r\n                $.proxy(function (data) {\r\n                    console.log(\"Couldn't cancel the task.\");\r\n                }),\r\n            );\r\n    }\r\n\r\n    delete() {\r\n        var posting = $.ajax({ url: this.api, type: \"DELETE\" })\r\n            .done(\r\n                $.proxy(function (data) {\r\n                    this.remove();\r\n                }, this),\r\n            )\r\n            .fail(\r\n                $.proxy(function (xhr) {\r\n                    console.log(\"Couldn't delete part \" + this.pk);\r\n                }, this),\r\n            );\r\n    }\r\n\r\n    static fromPk(pk) {\r\n        return $(\"#image-card-\" + pk).data(\"partCard\");\r\n    }\r\n    static getRange(from_, to_) {\r\n        var from, to;\r\n        if (from_ < to_) (from = from_), (to = to_);\r\n        else (from = to_), (to = from_);\r\n        return $(\"#cards-container .card\").slice(from, to + 1);\r\n    }\r\n    static getSelectedPks() {\r\n        var pks = [];\r\n        $(\"#cards-container .card\").each(function (i, el) {\r\n            var ic = $(el).data(\"partCard\");\r\n            if (ic.selected) {\r\n                pks.push(ic.pk);\r\n            }\r\n        });\r\n        return pks;\r\n    }\r\n    static refreshSelectedCount() {\r\n        $(\"#selected-counter\")\r\n            .text(\r\n                partCard.getSelectedPks().length +\r\n                    \"/\" +\r\n                    $(\"#cards-container .card\").length,\r\n            )\r\n            .parent()\r\n            .show();\r\n    }\r\n}\r\n\r\nfunction bootImageCards(\r\n    documentId,\r\n    diskStorageLeft,\r\n    cpuMinutesLeft,\r\n    showConfidenceViz,\r\n) {\r\n    DOCUMENT_ID = documentId;\r\n    API = {\r\n        document: \"/api/documents/\" + DOCUMENT_ID,\r\n        parts: \"/api/documents/\" + DOCUMENT_ID + \"/parts/\",\r\n        part: \"/api/documents/\" + DOCUMENT_ID + \"/parts/{part_pk}/\",\r\n    };\r\n    //************* Card ordering *************\r\n    $(\"#cards-container\").on(\"dragover\", \".js-drop\", function (ev) {\r\n        var index = $(\"#cards-container .js-drop\").index(ev.target);\r\n        var elementId = ev.originalEvent.dataTransfer.getData(\"text/card-id\");\r\n        if (!elementId && g_dragged != null) {\r\n            elementId = g_dragged;\r\n        } // for chrome\r\n        var dragged_index = $(\"#cards-container .card\").index(\r\n            document.getElementById(elementId),\r\n        );\r\n        var isCard =\r\n            ev.originalEvent.dataTransfer.types.indexOf(\"text/card-id\") != -1;\r\n        if (isCard && index != dragged_index && index != dragged_index + 1) {\r\n            $(ev.target).addClass(\"drop-accept\");\r\n            ev.preventDefault();\r\n        }\r\n    });\r\n\r\n    $(\"#cards-container\").on(\"dragleave\", \".js-drop\", function (ev) {\r\n        ev.preventDefault();\r\n        $(ev.target).removeClass(\"drop-accept\");\r\n    });\r\n\r\n    $(\"#cards-container\").on(\"drop\", \".js-drop\", function (ev) {\r\n        ev.preventDefault();\r\n        $(ev.target).removeClass(\"drop-accept\");\r\n        var elementId = ev.originalEvent.dataTransfer.getData(\"text/card-id\");\r\n        if (!elementId) {\r\n            elementId = g_dragged;\r\n        } // for chrome\r\n        var dragged = document.getElementById(elementId);\r\n        var card = $(dragged).data(\"partCard\");\r\n        var index = $(\"#cards-container .js-drop\").index(ev.target);\r\n        card.moveTo(index);\r\n        g_dragged = null;\r\n    });\r\n\r\n    // update workflow icons, send by notification through web socket\r\n    var workflow_order = [\"pending\", \"ongoing\", \"error\", \"done\"];\r\n\r\n    function updateWorkflow(card, data) {\r\n        if (\r\n            (!data.task_id || card.task_ids[data.process] == data.task_id) &&\r\n            workflow_order.indexOf(card.workflow[data.process]) >\r\n                workflow_order.indexOf(data.status)\r\n        ) {\r\n            return; // protection against race condition\r\n        }\r\n        card.workflow[data.process] = data.status;\r\n        if (data.task_id) card.task_ids[data.process] = data.task_id;\r\n        card.updateWorkflowIcons();\r\n\r\n        // special case, done with thumbnails:\r\n        if (\r\n            data.process == \"generate_part_thumbnails\" &&\r\n            data.status == \"done\"\r\n        ) {\r\n            card.image.thumbnails = data.data;\r\n            card.updateThumbnail();\r\n        }\r\n    }\r\n\r\n    $(\"#alerts-container\").on(\"part:workflow\", function (ev, data) {\r\n        var card = partCard.fromPk(data.id);\r\n        if (card) {\r\n            updateWorkflow(card, data);\r\n        } else {\r\n            // we probably received the event before the card was created, retrigger ev in a sec\r\n            setTimeout(function () {\r\n                $(\"#alerts-container\").trigger(ev, data);\r\n            }, 100);\r\n        }\r\n    });\r\n    $(\"#alerts-container\").on(\"parts:workflow\", function (ev, data) {\r\n        // Same thing than above but receive more than one part at a time.\r\n        for (var i = 0; i < data.parts.length; i++) {\r\n            var card = partCard.fromPk(data.parts[i].id);\r\n            if (card) {\r\n                updateWorkflow(card, data.parts[i]);\r\n            }\r\n        }\r\n    });\r\n\r\n    $(\"#alerts-container\").on(\"part:new\", function (ev, data) {\r\n        var card = partCard.fromPk(data.id);\r\n        var uri = API.part.replace(\"{part_pk}\", data.id);\r\n        $.get(uri, function (data) {\r\n            if (!card) {\r\n                new partCard(data, cpuMinutesLeft);\r\n                partCard.refreshSelectedCount();\r\n            } else {\r\n                if (!card.image.thumbnails) card.image.thumbnails = {};\r\n                card.image.thumbnails[\"card\"] =\r\n                    data[\"image\"][\"thumbnails\"][\"card\"];\r\n                card.updateThumbnail();\r\n                card.domElement.scrollIntoView(false);\r\n            }\r\n        });\r\n    });\r\n    $(\"#alerts-container\").on(\"part:delete\", function (ev, data) {\r\n        var card = partCard.fromPk(data.id);\r\n        if (card) {\r\n            card.remove();\r\n        }\r\n    });\r\n\r\n    // Imports\r\n    let $alertsContainer = $(\"#alerts-container\");\r\n    $alertsContainer.on(\"import:start\", function (ev, data) {\r\n        $(\"#import-counter\").parent().addClass(\"ongoing\");\r\n        $(\"#import-selected\").addClass(\"blink\");\r\n        $(\"#import-resume\").hide();\r\n    });\r\n    $alertsContainer.on(\"import:progress\", function (ev, data) {\r\n        $(\"#import-counter\").parent().addClass(\"ongoing\");\r\n        $(\"#import-selected\").addClass(\"blink\");\r\n        $(\"#cancel-import\").show();\r\n        if (data.progress) {\r\n            $(\"#import-counter\").text(data.progress + \"/\" + data.total);\r\n        }\r\n    });\r\n    $alertsContainer.on(\"import:warning\", function (ev, data) {\r\n        Alert.add(Date.now(), data.reason, \"warning\");\r\n    });\r\n    $alertsContainer.on(\"import:error\", function (ev, data) {\r\n        $(\"#import-counter\").text(\"Failed.\");\r\n        $(\"#import-selected\").removeClass(\"blink\");\r\n        $(\"#cancel-import\").hide();\r\n        if (data.reason) {\r\n            Alert.add(\r\n                \"import-failed\",\r\n                \"Import failed because '\" + data.reason + \"'\",\r\n                \"danger\",\r\n            );\r\n        }\r\n    });\r\n    $alertsContainer.on(\"import:done\", function (ev, data) {\r\n        $(\"#import-counter\").text(\"Done.\");\r\n        $(\"#import-counter\").parent().removeClass(\"ongoing\");\r\n        $(\"#import-selected\").removeClass(\"blink\");\r\n        $(\"#cancel-import\").hide();\r\n    });\r\n    $(\"#cancel-import\").click(function (ev, data) {\r\n        let url = API.document + \"/cancel_import/\";\r\n        $.post(url, {})\r\n            .done(function (data) {\r\n                $(\"#import-counter\").text(\"canceled\");\r\n                $(\"#import-counter\").parent().removeClass(\"ongoing\");\r\n                $(\"#import-selected\").removeClass(\"blink\");\r\n            })\r\n            .fail(function (data) {\r\n                console.log(\"Couldn't cancel import\");\r\n            });\r\n    });\r\n\r\n    // Exports\r\n    var $exportBtn = $(\"#document-export\");\r\n    $alertsContainer.on(\"export:start\", function (ev, data) {\r\n        $exportBtn.addClass(\"blink\");\r\n    });\r\n    $alertsContainer.on(\"export:error\", function (ev, data) {\r\n        $exportBtn.removeClass(\"blink\");\r\n        $exportBtn.addClass(\"error\");\r\n        if (data.reason) {\r\n            Alert.add(\r\n                \"export-failed\",\r\n                \"Export failed because '\" + data.reason + \"'\",\r\n                \"danger\",\r\n            );\r\n        }\r\n    });\r\n    $alertsContainer.on(\"export:done\", function (ev, data) {\r\n        $exportBtn.removeClass(\"blink\");\r\n    });\r\n\r\n    // disables including images for text export\r\n    $(\"#process-part-form-export #id_file_format\").on(\"change\", function (ev) {\r\n        let sel = ev.target;\r\n        if ($(sel).val() == \"text\") {\r\n            $(\"#process-part-form-export #include_images\").prop(\r\n                \"checked\",\r\n                false,\r\n            );\r\n            $(\"#process-part-form-export #include_images\").prop(\r\n                \"disabled\",\r\n                true,\r\n            );\r\n        } else {\r\n            $(\"#process-part-form-export #include_images\").prop(\r\n                \"disabled\",\r\n                false,\r\n            );\r\n        }\r\n    });\r\n\r\n    // training\r\n    var max_accuracy = 0;\r\n    $alertsContainer.on(\"training:start\", function (ev, data) {\r\n        $(\"#train-selected\").addClass(\"blink\");\r\n        $(\"#cancel-training\").show();\r\n    });\r\n    $alertsContainer.on(\"training:gathering\", function (ev, data) {\r\n        $(\"#train-selected\").addClass(\"blink\");\r\n        $(\"#cancel-training\").show();\r\n    });\r\n    $alertsContainer.on(\"training:eval\", function (ev, data) {\r\n        $(\"#train-selected\").addClass(\"blink\");\r\n        $(\"#cancel-training\").show();\r\n    });\r\n    $alertsContainer.on(\"training:done\", function (ev, data) {\r\n        $(\"#train-selected\").removeClass(\"blink\");\r\n        $(\"#cancel-training\").hide();\r\n    });\r\n    $alertsContainer.on(\"training:error\", function (ev, data) {\r\n        $(\"#train-selected\").removeClass(\"blink\").addClass(\"btn-danger\");\r\n        $(\"#cancel-training\").hide();\r\n        if (data.reason) {\r\n            Alert.add(\r\n                \"training-failed\",\r\n                \"Training failed because '\" + data.reason + \"'\",\r\n                \"danger\",\r\n            );\r\n        }\r\n    });\r\n    $(\"#cancel-training\").click(function (ev, data) {\r\n        let url = API.document + \"/cancel_training/\";\r\n        $.post(url, {})\r\n            .done(function (data) {\r\n                $(\"#train-selected\").removeClass(\"blink\");\r\n                $(\"#cancel-training\").hide();\r\n            })\r\n            .fail(function (data) {\r\n                console.log(\"Couldn't cancel training\");\r\n            });\r\n    });\r\n\r\n    // create & configure dropzone\r\n    var imageDropzone = new Dropzone(\".dropzone\", {\r\n        paramName: \"image\",\r\n        timeout: 0,\r\n        // chunking: true,\r\n        // retryChunks: true,\r\n        parallelUploads: 1, // ! important or the 'order' field gets duplicates\r\n        error: (file, message) => {\r\n            if (file.previewElement) {\r\n                file.previewElement.classList.add(\"dz-error\");\r\n                if (typeof message !== \"string\" && message.image) {\r\n                    message = message.image.toString();\r\n                }\r\n                for (let node of file.previewElement.querySelectorAll(\r\n                    \"[data-dz-errormessage]\",\r\n                )) {\r\n                    node.textContent = message;\r\n                }\r\n            }\r\n        },\r\n    });\r\n\r\n    //************* New card creation **************\r\n    imageDropzone.on(\"success\", function (file, data) {\r\n        // cleanup the dropzone if previews are pilling up\r\n        if (imageDropzone.files.length > 7) {\r\n            // a bit arbitrary, depends on the screen but oh well\r\n            for (var i = 0; i < imageDropzone.files.length - 7; i++) {\r\n                if (imageDropzone.files[i].status == \"success\") {\r\n                    imageDropzone.removeFile(imageDropzone.files[i]);\r\n                }\r\n            }\r\n        }\r\n    });\r\n\r\n    if (diskStorageLeft === \"False\") imageDropzone.disable();\r\n\r\n    // processor buttons\r\n    $(\"#select-all\").click(function (ev) {\r\n        var cards = partCard.getRange(0, $(\"#cards-container .card\").length);\r\n        cards.each(function (i, el) {\r\n            $(el).data(\"partCard\").select(false);\r\n        });\r\n        partCard.refreshSelectedCount();\r\n    });\r\n    $(\"#unselect-all\").click(function (ev) {\r\n        var cards = partCard.getRange(0, $(\"#cards-container .card\").length);\r\n        cards.each(function (i, el) {\r\n            $(el).data(\"partCard\").unselect();\r\n        });\r\n        partCard.refreshSelectedCount();\r\n    });\r\n\r\n    $(\".js-proc-selected\").click(function (ev) {\r\n        openWizard($(ev.target).data(\"proc\"));\r\n    });\r\n\r\n    $(\"#process-part-form-transcribe #id_model\").on(\"change\", function (ev) {\r\n        var modelName = ev.target.options[ev.target.selectedIndex].innerHTML;\r\n        var options = document.querySelectorAll(\r\n            \"#process-part-form-transcribe #id_transcription option\",\r\n        );\r\n        var opt = Array.from(options).find(\r\n            (o) => o.innerHTML == \"kraken:\" + modelName,\r\n        );\r\n        if (opt) {\r\n            opt.selected = true;\r\n        }\r\n    });\r\n\r\n    $(\"#process-part-form-export\").submit(function (ev) {\r\n        // store the export format choice for later use\r\n        var export_format = $(\r\n            \"#process-part-form-export #id_file_format\",\r\n        ).val();\r\n        userProfile.set(\"exportFormat\", export_format);\r\n    });\r\n\r\n    $(\".process-part-form\").submit(function (ev) {\r\n        ev.preventDefault();\r\n        var $form = $(ev.target);\r\n        var $submitButton = $(\".js-submit-proc\", $form);\r\n        var proc = $form.data(\"proc\");\r\n\r\n        $submitButton.prop(\"disabled\", true);\r\n        var $icon = $('<i class=\"fas fa-spinner fa-spin ml-2\">');\r\n        $submitButton.append($icon);\r\n\r\n        let data = new FormData($form.get(0));\r\n        data.set(\"document\", DOCUMENT_ID);\r\n        partCard.getSelectedPks().forEach((v) => data.append(\"parts\", v));\r\n\r\n        // remove previous errors\r\n        $(\"div.field-error\", $form).remove();\r\n\r\n        $.ajax({\r\n            url: $form.attr(\"action\"),\r\n            type: $form.attr(\"method\"),\r\n            data: data,\r\n            processData: false,\r\n            contentType: false,\r\n        })\r\n            .done(function (data) {\r\n                if (DEBUG) console.log(proc + \" process\", data.status);\r\n                if (proc == \"import-xml\" || proc == \"import-iiif\") {\r\n                    $(\"#import-counter\")\r\n                        .text(\"Queued.\")\r\n                        .show()\r\n                        .parent()\r\n                        .addClass(\"ongoing\");\r\n                } else if (proc == \"train\") {\r\n                    $(\"#train-selected\")\r\n                        .addClass(\"blink\")\r\n                        .removeClass(\"btn-danger\");\r\n                }\r\n                $submitButton.prop(\"disabled\", false);\r\n                $icon.remove();\r\n                $(\"#\" + proc + \"-wizard\").modal(\"hide\");\r\n            })\r\n            .fail(function (xhr) {\r\n                var data = xhr.responseJSON;\r\n                if (data.status == \"error\") {\r\n                    var errors = JSON.parse(data.error);\r\n                    $(\"#\" + proc + \"-wizard #wizard-form-error\").text(\r\n                        errors.__all__,\r\n                    );\r\n                    for (let input_name in errors) {\r\n                        let input = $(\"#\" + proc + \"-wizard #id_\" + input_name);\r\n                        let errorNode = $('<div class=\"error field-error\">');\r\n                        errorNode.text(errors[input_name]);\r\n                        input.parent().append(errorNode);\r\n                    }\r\n                }\r\n                $submitButton.prop(\"disabled\", false);\r\n                $icon.remove();\r\n                if (DEBUG) console.log(xhr);\r\n            });\r\n    });\r\n\r\n    /* Select card if coming from edit page */\r\n    var tabUrl = new URL(window.location);\r\n    var select = tabUrl.searchParams.get(\"select\");\r\n\r\n    /* fetch the images and create the cards */\r\n    var counter = 0;\r\n    var getNextParts = function (page) {\r\n        var uri = API.parts + \"?paginate_by=50&page=\" + page;\r\n        $.get(uri, function (data) {\r\n            counter += data.results.length;\r\n            $(\"#loading-counter\").html(counter + \"/\" + data.count);\r\n            for (var i = 0; i < data.results.length; i++) {\r\n                var pc = new partCard(\r\n                    data.results[i],\r\n                    cpuMinutesLeft,\r\n                    showConfidenceViz,\r\n                );\r\n                if (select == pc.pk) pc.select();\r\n            }\r\n            if (data.next) {\r\n                getNextParts(page + 1);\r\n            } else {\r\n                $(\"#loading-counter\").parent().hide();\r\n                partCard.refreshSelectedCount();\r\n            }\r\n        });\r\n    };\r\n    getNextParts(1);\r\n}\r\n\n\n//# sourceURL=webpack://escriptorium/./src/image_cards.js?");

/***/ }),

/***/ "./src/lazyload.js":
/*!*************************!*\
  !*** ./src/lazyload.js ***!
  \*************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   addImageToLoader: () => (/* binding */ addImageToLoader),\n/* harmony export */   bootLazyload: () => (/* binding */ bootLazyload)\n/* harmony export */ });\nvar imageObserver;\r\nfunction bootLazyload() {\r\n    var lazyloadImages;\r\n\r\n    if (\"IntersectionObserver\" in window) {\r\n        lazyloadImages = document.querySelectorAll(\".lazy\");\r\n        imageObserver = new IntersectionObserver(function (entries, observer) {\r\n            entries.forEach(function (entry) {\r\n                if (entry.isIntersecting) {\r\n                    // isIntersecting doesn't work on chrome for empty svg image\r\n                    // so we need to put the lazy class on the parent <svg>\r\n                    let image = entry.target.dataset.src\r\n                        ? entry.target\r\n                        : entry.target.querySelector(\"[data-src]\");\r\n                    if (image.namespaceURI.includes(\"svg\"))\r\n                        image.setAttributeNS(\r\n                            \"http://www.w3.org/1999/xlink\",\r\n                            \"xlink:href\",\r\n                            image.dataset.src,\r\n                        );\r\n                    else image.setAttribute(\"src\", image.dataset.src);\r\n                    image.classList.remove(\"lazy\");\r\n                    imageObserver.unobserve(image);\r\n                }\r\n            });\r\n        });\r\n\r\n        lazyloadImages.forEach(function (image) {\r\n            imageObserver.observe(image);\r\n        });\r\n    } else {\r\n        var lazyloadThrottleTimeout;\r\n        lazyloadImages = document.querySelectorAll(\".lazy\");\r\n\r\n        function lazyload() {\r\n            if (lazyloadThrottleTimeout) {\r\n                clearTimeout(lazyloadThrottleTimeout);\r\n            }\r\n\r\n            lazyloadThrottleTimeout = setTimeout(function () {\r\n                var scrollTop = window.pageYOffset;\r\n                lazyloadImages.forEach(function (img) {\r\n                    if (img.offsetTop < window.innerHeight + scrollTop) {\r\n                        img.src = img.dataset.src;\r\n                        img.classList.remove(\"lazy\");\r\n                    }\r\n                });\r\n                if (lazyloadImages.length == 0) {\r\n                    document.removeEventListener(\"scroll\", lazyload);\r\n                    window.removeEventListener(\"resize\", lazyload);\r\n                    window.removeEventListener(\"orientationChange\", lazyload);\r\n                }\r\n            }, 20);\r\n        }\r\n\r\n        document.addEventListener(\"scroll\", lazyload);\r\n        window.addEventListener(\"resize\", lazyload);\r\n        window.addEventListener(\"orientationChange\", lazyload);\r\n    }\r\n}\r\n\r\nfunction addImageToLoader(img) {\r\n    imageObserver.observe($(\"img\", img).get(0));\r\n}\r\n\n\n//# sourceURL=webpack://escriptorium/./src/lazyload.js?");

/***/ }),

/***/ "./src/main.js":
/*!*********************!*\
  !*** ./src/main.js ***!
  \*********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _css_escriptorium_css__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../css/escriptorium.css */ \"./css/escriptorium.css\");\n/* harmony import */ var _css_rtl_css__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../css/rtl.css */ \"./css/rtl.css\");\n/* harmony import */ var _css_ttb_css__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../css/ttb.css */ \"./css/ttb.css\");\n/* harmony import */ var _recogito_annotorious_dist_annotorious_min_css__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! @recogito/annotorious/dist/annotorious.min.css */ \"./node_modules/@recogito/annotorious/dist/annotorious.min.css\");\n/* harmony import */ var _recogito_recogito_js_dist_recogito_min_css__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! @recogito/recogito-js/dist/recogito.min.css */ \"./node_modules/@recogito/recogito-js/dist/recogito.min.css\");\n/* harmony import */ var _ajax_js__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! ./ajax.js */ \"./src/ajax.js\");\n/* harmony import */ var _ajax_js__WEBPACK_IMPORTED_MODULE_5___default = /*#__PURE__*/__webpack_require__.n(_ajax_js__WEBPACK_IMPORTED_MODULE_5__);\n/* harmony import */ var _messages_js__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ./messages.js */ \"./src/messages.js\");\n/* harmony import */ var _help_js__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ./help.js */ \"./src/help.js\");\n/* harmony import */ var _lazyload_js__WEBPACK_IMPORTED_MODULE_8__ = __webpack_require__(/*! ./lazyload.js */ \"./src/lazyload.js\");\n/* harmony import */ var _wheelzoom_js__WEBPACK_IMPORTED_MODULE_9__ = __webpack_require__(/*! ./wheelzoom.js */ \"./src/wheelzoom.js\");\n/* harmony import */ var _profile_js__WEBPACK_IMPORTED_MODULE_10__ = __webpack_require__(/*! ./profile.js */ \"./src/profile.js\");\n/* harmony import */ var _formsets_js__WEBPACK_IMPORTED_MODULE_11__ = __webpack_require__(/*! ./formsets.js */ \"./src/formsets.js\");\n/* harmony import */ var _document_form_js__WEBPACK_IMPORTED_MODULE_12__ = __webpack_require__(/*! ./document_form.js */ \"./src/document_form.js\");\n/* harmony import */ var _ontology_form_js__WEBPACK_IMPORTED_MODULE_13__ = __webpack_require__(/*! ./ontology_form.js */ \"./src/ontology_form.js\");\n/* harmony import */ var _image_cards_js__WEBPACK_IMPORTED_MODULE_14__ = __webpack_require__(/*! ./image_cards.js */ \"./src/image_cards.js\");\n/* harmony import */ var _models_js__WEBPACK_IMPORTED_MODULE_15__ = __webpack_require__(/*! ./models.js */ \"./src/models.js\");\n/* harmony import */ var _align_form_js__WEBPACK_IMPORTED_MODULE_16__ = __webpack_require__(/*! ./align_form.js */ \"./src/align_form.js\");\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nwindow.Alert = _messages_js__WEBPACK_IMPORTED_MODULE_6__.Alert;\r\nwindow.bootWebsocket = _messages_js__WEBPACK_IMPORTED_MODULE_6__.bootWebsocket;\r\nwindow.joinDocumentRoom = _messages_js__WEBPACK_IMPORTED_MODULE_6__.joinDocumentRoom;\r\n\r\n\r\nwindow.bootHelp = _help_js__WEBPACK_IMPORTED_MODULE_7__.bootHelp;\r\n\r\n\r\nwindow.bootLazyload = _lazyload_js__WEBPACK_IMPORTED_MODULE_8__.bootLazyload;\r\nwindow.addImageToLoader = _lazyload_js__WEBPACK_IMPORTED_MODULE_8__.addImageToLoader;\r\n\r\n\r\nwindow.WheelZoom = _wheelzoom_js__WEBPACK_IMPORTED_MODULE_9__.WheelZoom;\r\n\r\n\r\nwindow.userProfile = _profile_js__WEBPACK_IMPORTED_MODULE_10__.userProfile;\r\n\r\n\r\nwindow.setupFormSet = _formsets_js__WEBPACK_IMPORTED_MODULE_11__.setupFormSet;\r\n\r\n\r\nwindow.bootDocumentForm = _document_form_js__WEBPACK_IMPORTED_MODULE_12__.bootDocumentForm;\r\n\r\n\r\nwindow.bootOntologyForm = _ontology_form_js__WEBPACK_IMPORTED_MODULE_13__.bootOntologyForm;\r\n\r\n\r\nwindow.bootImageCards = _image_cards_js__WEBPACK_IMPORTED_MODULE_14__.bootImageCards;\r\n\r\n\r\nwindow.bootModels = _models_js__WEBPACK_IMPORTED_MODULE_15__.bootModels;\r\n\r\n\r\nwindow.bootAlignForm = _align_form_js__WEBPACK_IMPORTED_MODULE_16__.bootAlignForm;\r\n\n\n//# sourceURL=webpack://escriptorium/./src/main.js?");

/***/ }),

/***/ "./src/messages.js":
/*!*************************!*\
  !*** ./src/messages.js ***!
  \*************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   Alert: () => (/* binding */ Alert),\n/* harmony export */   bootWebsocket: () => (/* binding */ bootWebsocket),\n/* harmony export */   joinDocumentRoom: () => (/* binding */ joinDocumentRoom),\n/* harmony export */   msgSocket: () => (/* binding */ msgSocket)\n/* harmony export */ });\nvar msgSocket;\r\n\r\nvar alerts = {};\r\nclass Alert {\r\n    constructor(id, message, level, links) {\r\n        this.id = id;\r\n        this.count = 1;\r\n        this.message = message;\r\n        this.level = level || \"info\";\r\n        this.links = links;\r\n        var $new = $(\".alert\", \"#alert-tplt\").clone();\r\n        $new.addClass(\"alert-\" + this.level);\r\n        $(\".message\", $new).html(message);\r\n        if (this.links !== undefined) {\r\n            for (let i = 0; i < this.links.length; i++) {\r\n                let link = $(\"<div>\").html(\r\n                    '<a href=\"' +\r\n                        this.links[i].src +\r\n                        '\" target=\"_blank\">' +\r\n                        this.links[i].text +\r\n                        \"</a>\",\r\n                );\r\n                if (this.links[i].cssClass)\r\n                    $(\"a\", link).addClass(this.links[i].cssClass);\r\n                if (this.links[i].targetBlank === false)\r\n                    $(\"a\", link).removeAttr(\"target\");\r\n                $(\".additional\", $new).append(link).css(\"display\", \"block\");\r\n            }\r\n        }\r\n        this.$element = $new;\r\n        this.htmlElement = this.$element.get(0);\r\n        $(\"#alerts-container\").append($new);\r\n        $new.show();\r\n\r\n        this.$element.on(\r\n            \"closed.bs.alert\",\r\n            $.proxy(function () {\r\n                delete alerts[this.id];\r\n            }, this),\r\n        );\r\n    }\r\n\r\n    static add(id, message, level, link) {\r\n        var id_ = id || new Date().getTime();\r\n        if (alerts[id_] === undefined) {\r\n            alerts[id_] = new Alert(id_, message, level, link);\r\n        } else {\r\n            alerts[id_].incrementCounter();\r\n        }\r\n        return alerts[id_];\r\n    }\r\n\r\n    incrementCounter() {\r\n        this.count++;\r\n        $(\".counter\", this.$element)\r\n            .text(\"(\" + this.count + \")\")\r\n            .show();\r\n    }\r\n}\r\n\r\nfunction bootWebsocket() {\r\n    let scheme = location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\r\n    msgSocket = new ReconnectingWebSocket(\r\n        scheme + \"//\" + window.location.host + \"/ws/notif/\",\r\n    );\r\n    msgSocket.maxReconnectAttempts = 3;\r\n\r\n    msgSocket.addEventListener(\"open\", function (e) {\r\n        if (DEBUG) {\r\n            console.log(\"Connected to notification socket\");\r\n        }\r\n    });\r\n\r\n    msgSocket.addEventListener(\"message\", function (e) {\r\n        var data = JSON.parse(e.data);\r\n        if (DEBUG) {\r\n            console.log(\"Received ws message: \", data);\r\n        }\r\n\r\n        if (data.type == \"message\") {\r\n            var message = data[\"text\"];\r\n            Alert.add(data[\"id\"], message, data[\"level\"], data[\"links\"]);\r\n        } else if (data.type == \"event\") {\r\n            var $container = $(\"#alerts-container\");\r\n            $container.trigger(data[\"name\"], data[\"data\"]);\r\n        }\r\n    });\r\n\r\n    msgSocket.addEventListener(\"close\", function (e) {\r\n        if (DEBUG) {\r\n            console.error(\"Notification socket closed unexpectedly\");\r\n        }\r\n    });\r\n}\r\n\r\nfunction joinDocumentRoom(pk) {\r\n    msgSocket.addEventListener(\"open\", function (e) {\r\n        msgSocket.send(\r\n            '{\"type\": \"join-room\", \"object_cls\": \"document\", \"object_pk\": ' +\r\n                pk +\r\n                \" }\",\r\n        );\r\n    });\r\n}\r\n\n\n//# sourceURL=webpack://escriptorium/./src/messages.js?");

/***/ }),

/***/ "./src/models.js":
/*!***********************!*\
  !*** ./src/models.js ***!
  \***********************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   bootModels: () => (/* binding */ bootModels)\n/* harmony export */ });\nfunction bootModels() {\r\n    let $alertsContainer = $(\"#alerts-container\");\r\n\r\n    let max_accuracy = {};\r\n\r\n    $(\"#models-table tr.model-head\").each(function (i, e) {\r\n        max_accuracy[$(e).data(\"id\")] = $(\r\n            \"td#accuracy-\" + $(e).data(\"id\"),\r\n            e,\r\n        ).data(\"value\");\r\n    });\r\n\r\n    $alertsContainer.on(\"training:start\", function (ev, data) {\r\n        let $row = $(\"tr#tr-\" + data.id);\r\n        $(\".training-ongoing\", $row).show();\r\n        $(\".training-done\", $row).hide();\r\n        $(\".training-error\", $row).hide();\r\n        $(\".cancel-training\", $row).show();\r\n    });\r\n    $alertsContainer.on(\"training:gathering\", function (ev, data) {\r\n        let $row = $(\"tr#tr-\" + data.id);\r\n        $(\".training-ongoing\", $row).show();\r\n        $(\".training-done\", $row).hide();\r\n        $(\".training-error\", $row).hide();\r\n        $(\".training-gathering\", $row).css(\"display\", \"flex\");\r\n        $(\".training-gathering .progress-bar\", $row).css(\r\n            \"width\",\r\n            Math.round((data.index / data.total) * 100) + \"%\",\r\n        );\r\n        $(\".cancel-training\", $row).show();\r\n    });\r\n    $alertsContainer.on(\"training:eval\", function (ev, data) {\r\n        let $row = $(\"tr#tr-\" + data.id);\r\n        $(\".training-ongoing\", $row).show();\r\n        $(\".training-done\", $row).hide();\r\n        $(\".training-error\", $row).hide();\r\n        $(\".training-gathering\", $row).hide();\r\n        if (max_accuracy[data.id] < data.accuracy) {\r\n            $row.data(\"value\", data.accuracy);\r\n            $(\"td#accuracy-\" + data.id, $row).text(\r\n                Math.round(data.accuracy * 100 * 100) / 100 + \"%\",\r\n            );\r\n            max_accuracy[data.id] = data.accuracy;\r\n        }\r\n        $(\".cancel-training\", $row).show();\r\n    });\r\n    $alertsContainer.on(\"training:done\", function (ev, data) {\r\n        let $row = $(\"tr#tr-\" + data.id);\r\n        $(\".training-ongoing\", $row).hide();\r\n        $(\".training-done\", $row).show();\r\n        // $('.training-error', $row).hide();\r\n        $(\".training-gathering\", $row).hide();\r\n        $(\".cancel-training\", $row).hide();\r\n    });\r\n    $alertsContainer.on(\"training:error\", function (ev, data) {\r\n        let $row = $(\"tr#tr-\" + data.id);\r\n        $(\".training-ongoing\", $row).hide();\r\n        $(\".training-done\", $row).hide();\r\n        $(\".training-error\", $row).show();\r\n        $(\".cancel-training\", $row).hide();\r\n    });\r\n}\r\n\n\n//# sourceURL=webpack://escriptorium/./src/models.js?");

/***/ }),

/***/ "./src/ontology_form.js":
/*!******************************!*\
  !*** ./src/ontology_form.js ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   bootOntologyForm: () => (/* binding */ bootOntologyForm)\n/* harmony export */ });\n\r\n\r\nfunction bootOntologyForm() {\r\n    /*** Region/Line types ***/\r\n    function pushType(type, name) {\r\n        let uri = \"/api/types/\" + type + \"/\";\r\n        return fetch(uri, {\r\n            method: \"post\",\r\n            credentials: \"same-origin\",\r\n            headers: {\r\n                \"X-CSRFToken\": Cookies.get(\"csrftoken\"),\r\n                Accept: \"application/json\",\r\n                \"Content-Type\": \"application/json\",\r\n            },\r\n            body: JSON.stringify({ name: name }),\r\n        });\r\n    }\r\n\r\n    var submittedForm = false;\r\n    let form = document.querySelector(\"#ontology-form\");\r\n    form.addEventListener(\"submit\", (ev) => (submittedForm = true));\r\n\r\n    function addTypeOption(parent, pk, name) {\r\n        let checks = document.querySelectorAll(parent + \" .form-check\");\r\n        let last_check = checks[checks.length - 1];\r\n        let new_check = last_check.cloneNode(true);\r\n        let new_input = new_check.querySelector(\"input\");\r\n        new_input.value = pk;\r\n        new_input.checked = true;\r\n        new_check.querySelector(\"label\").textContent = name;\r\n        last_check.after(new_check);\r\n\r\n        // if trying to leave the page without updating show a warning\r\n        window.addEventListener(\"beforeunload\", function (ev) {\r\n            if (!submittedForm) {\r\n                var confirmationMessage =\r\n                    \"It looks like you have unsaved Types. \" +\r\n                    \"If you leave before saving, your changes will be lost.\";\r\n                (ev || window.event).returnValue = confirmationMessage;\r\n                return confirmationMessage;\r\n            }\r\n        });\r\n    }\r\n\r\n    document\r\n        .getElementById(\"add-region-type-btn\")\r\n        .addEventListener(\"click\", function (ev) {\r\n            ev.preventDefault();\r\n            let input = document.getElementById(\"add-region-type-input\");\r\n            if (input.value) {\r\n                pushType(\"block\", input.value)\r\n                    .then((response) => response.json())\r\n                    .then(function (data) {\r\n                        addTypeOption(\"#region-types\", data.pk, data.name);\r\n                        input.value = \"\"; // empty the input for future use\r\n                    });\r\n            }\r\n        });\r\n\r\n    document\r\n        .getElementById(\"add-line-type-btn\")\r\n        .addEventListener(\"click\", function (ev) {\r\n            ev.preventDefault();\r\n            let input = document.getElementById(\"add-line-type-input\");\r\n            if (input.value) {\r\n                pushType(\"line\", input.value)\r\n                    .then((response) => response.json())\r\n                    .then(function (data) {\r\n                        addTypeOption(\"#line-types\", data.pk, data.name);\r\n                        input.value = \"\"; // empty the input for future use\r\n                    });\r\n            }\r\n        });\r\n\r\n    document\r\n        .getElementById(\"add-part-type-btn\")\r\n        .addEventListener(\"click\", function (ev) {\r\n            ev.preventDefault();\r\n            let input = document.getElementById(\"add-part-type-input\");\r\n            if (input.value) {\r\n                pushType(\"part\", input.value)\r\n                    .then((response) => response.json())\r\n                    .then(function (data) {\r\n                        addTypeOption(\"#part-types\", data.pk, data.name);\r\n                        input.value = \"\"; // empty the input for future use\r\n                    });\r\n            }\r\n        });\r\n\r\n    /*** Annotations ***/\r\n    setupFormSet(document.getElementById(\"ontology-form\"));\r\n}\r\n\n\n//# sourceURL=webpack://escriptorium/./src/ontology_form.js?");

/***/ }),

/***/ "./src/profile.js":
/*!************************!*\
  !*** ./src/profile.js ***!
  \************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   userProfile: () => (/* binding */ userProfile)\n/* harmony export */ });\nclass Profile {\r\n    constructor() {\r\n        let profile = window.localStorage.getItem(\"escriptorium.userProfile\");\r\n        if (profile) {\r\n            this.settings = JSON.parse(profile).settings;\r\n        } else {\r\n            this.settings = {};\r\n        }\r\n    }\r\n\r\n    saveProfile() {\r\n        window.localStorage.setItem(\r\n            \"escriptorium.userProfile\",\r\n            JSON.stringify({\r\n                settings: this.settings,\r\n            }),\r\n        );\r\n    }\r\n\r\n    set(key, value) {\r\n        this.settings[key] = value;\r\n        this.saveProfile();\r\n    }\r\n\r\n    get(key, default_) {\r\n        if (this.settings[key] !== undefined) return this.settings[key];\r\n        else return default_;\r\n    }\r\n\r\n    delete(key) {\r\n        delete this.settings[key];\r\n        this.saveProfile();\r\n    }\r\n\r\n    setUserId(id) {\r\n        this.userId = id;\r\n    }\r\n\r\n    getCookieConsent() {\r\n        // get cookie consent.\r\n        if (!this.get(\"cookie-consent\")) {\r\n            let alert = Alert.add(\r\n                \"cookie-consent\",\r\n                \"eScriptorium uses cookies to store the user session and local storage to save user interface preferences.\",\r\n                \"warning\",\r\n                [\r\n                    {\r\n                        src: \"\",\r\n                        text: \"Accept\",\r\n                        cssClass: \"btn btn-outline-dark btn-sm mt-2\",\r\n                        targetBlank: false,\r\n                    },\r\n                ],\r\n            );\r\n            alert.htmlElement.querySelector(\".additional a\").addEventListener(\r\n                \"click\",\r\n                function (ev) {\r\n                    this.set(\"cookie-consent\", true);\r\n                    return false;\r\n                }.bind(this),\r\n            );\r\n        }\r\n    }\r\n\r\n    resetCookieConsent() {\r\n        // convenience method\r\n        this.set(\"cookie-consent\", false);\r\n    }\r\n}\r\n\r\nvar userProfile = new Profile();\r\n\n\n//# sourceURL=webpack://escriptorium/./src/profile.js?");

/***/ }),

/***/ "./src/wheelzoom.js":
/*!**************************!*\
  !*** ./src/wheelzoom.js ***!
  \**************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   WheelZoom: () => (/* binding */ WheelZoom)\n/* harmony export */ });\n/*\r\n * Usage:\r\n * var zoom = new WheelZoom(domElement)\r\n * zoom.register(container);\r\n */\r\n\r\n\r\n\r\nclass zoomTarget {\r\n    constructor(\r\n        domElement,\r\n        {\r\n            map = false,\r\n            mapScale = 0.2,\r\n            mapColors = [\"grey\", \"white\"],\r\n            mapMargin = 10,\r\n            mapDuration = 2,\r\n        },\r\n    ) {\r\n        // wrap the element in a container:\r\n        var container = document.createElement(\"div\");\r\n        container.classList.add(\"js-wheelzoom-container\");\r\n        // disables right click menu\r\n        container.addEventListener(\"contextmenu\", function (e) {\r\n            e.preventDefault();\r\n        });\r\n        // var rotationContainer = document.createElement('div');\r\n        domElement.parentNode.insertBefore(container, domElement);\r\n        container.appendChild(domElement);\r\n        // rotationContainer.appendChild(domElement);\r\n        // container.appendChild(rotationContainer);\r\n        // rotationContainer.style.transformOrigin = 'center';\r\n        container.style.position = \"relative\";\r\n        container.style.overflow = \"hidden\";\r\n        // container.style.width = '100%';\r\n        // container.style.height = '100%';\r\n        domElement.style.transformOrigin = \"0 0\";\r\n        domElement.style.transition = \"scale 0.3s\";\r\n        // domElement.style.display = 'block';\r\n        domElement.classList.add(\"js-zoom-target\");\r\n        this.container = container;\r\n        //this.rotationContainer = rotationContainer;\r\n        this.element = domElement;\r\n\r\n        this.map = map;\r\n        if (this.map) {\r\n            this.mapScale = mapScale;\r\n            this.mapDuration = mapDuration;\r\n            this.mapTimer = null;\r\n            this.mapMargin = mapMargin;\r\n            this.makeMap(mapMargin, mapColors);\r\n            this.refreshMap();\r\n        }\r\n    }\r\n\r\n    update(pos, scale) {\r\n        this.element.style.transform =\r\n            \"translate(\" +\r\n            pos.x +\r\n            \"px,\" +\r\n            pos.y +\r\n            \"px) \" +\r\n            \"scale(\" +\r\n            scale +\r\n            \")\";\r\n    }\r\n\r\n    showMap(pos, scale) {\r\n        if (this.map && scale > 1) {\r\n            this.refreshMap();\r\n            this.mapWhole.style.opacity = 0.7;\r\n            this.mapCurrent.textContent = Math.round(scale * 100) + \"%\";\r\n            this.mapCurrent.style.transform =\r\n                \"\" +\r\n                \"translate(\" +\r\n                (-pos.x * this.mapScale) / scale +\r\n                \"px,\" +\r\n                (-pos.y * this.mapScale) / scale +\r\n                \"px) \" +\r\n                \"scale(\" +\r\n                1 / scale +\r\n                \")\";\r\n\r\n            // fadeOut\r\n            if (this.mapTimer) clearInterval(this.mapTimer);\r\n            let nTicks = (this.mapDuration * 1000) / 100;\r\n            let factor = this.mapWhole.style.opacity / nTicks;\r\n            this.mapTimer = setInterval(\r\n                function () {\r\n                    if (this.mapWhole.style.opacity <= 0) {\r\n                        clearInterval(this.mapTimer);\r\n                    }\r\n                    this.mapWhole.style.opacity =\r\n                        this.mapWhole.style.opacity - factor;\r\n                }.bind(this),\r\n                100,\r\n            );\r\n        }\r\n    }\r\n\r\n    refreshMap() {\r\n        if (this.map) {\r\n            let bounds = this.container.getBoundingClientRect();\r\n            this.mapWhole.style.top = bounds.y + this.mapMargin + \"px\";\r\n            this.mapWhole.style.left = bounds.x + this.mapMargin + \"px\";\r\n            this.mapWhole.style.width = bounds.width * this.mapScale + \"px\";\r\n            this.mapWhole.style.height = bounds.height * this.mapScale + \"px\";\r\n        }\r\n    }\r\n\r\n    makeMap(mapMargin, mapColors) {\r\n        this.mapWhole = document.createElement(\"div\");\r\n        this.mapWhole.classList.add(\"wheelzoom-outter-map\");\r\n        this.mapWhole.style.position = \"fixed\";\r\n        this.mapWhole.style.opacity = 0;\r\n        this.mapWhole.style.backgroundColor = mapColors[0];\r\n        this.mapWhole.style.pointerEvents = \"none\";\r\n        this.container.appendChild(this.mapWhole);\r\n\r\n        this.mapCurrent = document.createElement(\"div\");\r\n        this.mapCurrent.classList.add(\"wheelzoom-inner-map\");\r\n        this.mapCurrent.style.position = \"absolute\";\r\n        this.mapCurrent.style.opacity = 0.5;\r\n        this.mapCurrent.style.width = \"100%\";\r\n        this.mapCurrent.style.height = \"100%\";\r\n        this.mapCurrent.style.backgroundColor = mapColors[1];\r\n        this.mapCurrent.style.transformOrigin = \"0 0\";\r\n        this.mapWhole.appendChild(this.mapCurrent);\r\n    }\r\n}\r\n\r\nclass WheelZoom {\r\n    constructor({\r\n        factor = 0.1,\r\n        minScale = 0.2,\r\n        maxScale = 10,\r\n        initialScale = 1,\r\n        disabled = false,\r\n        legacyModeEnabled = true,\r\n        getActiveTool = () => {},\r\n    } = {}) {\r\n        this.factor = factor;\r\n        this.minScale = minScale;\r\n        this.maxScale = maxScale;\r\n        this.initialScale = initialScale;\r\n        this.disabled = disabled;\r\n        this.legacyModeEnabled = legacyModeEnabled;\r\n        this.getActiveTool = getActiveTool;\r\n\r\n        // create a dummy tag for event bindings\r\n        this.events = document.createElement(\"div\");\r\n        this.events.classList.add(\"wheelzoom-events-js\");\r\n        document.body.appendChild(this.events);\r\n\r\n        this.targets = [];\r\n        this.previousEvent = null;\r\n        this.scale = this.initialScale;\r\n        this.angle = 0;\r\n        this.pos = { x: 0, y: 0 };\r\n    }\r\n\r\n    register(domElement, { mirror = false, map = false } = {}) {\r\n        this.events.addEventListener(\"wheelzoom.reset\", this.reset.bind(this));\r\n        this.events.addEventListener(\r\n            \"wheelzoom.refresh\",\r\n            this.refresh.bind(this),\r\n        );\r\n\r\n        let target = new zoomTarget(domElement, { map: map });\r\n        target.update(this.pos, this.scale);\r\n        this.targets.push(target);\r\n        if (!mirror) {\r\n            // domElement.style.cursor = 'zoom-in';\r\n\r\n            const scroll = function (event) {\r\n                // looks like it breaks on some configurations?\r\n                // if (event.altKey) return;  // supposed to move in history\r\n                // if (event.ctrlKey) return;  // browser zoom\r\n                this.scrolling = target;\r\n                this.scrolled.bind(this)(event);\r\n            }\r\n            const drag = function (event) {\r\n                // in case of mask over the element, bc we bind to document so event.target can be whatever\r\n                if (\r\n                    (this.legacyModeEnabled || this.getActiveTool() !== \"pan\") &&\r\n                    !(event.which === 3 || event.button === 2)\r\n                ) {\r\n                    return; // right click only\r\n                }\r\n                this.dragging = target;\r\n                this.draggable.bind(this)(event);\r\n            }\r\n\r\n            target.container.addEventListener(\"mousewheel\", scroll.bind(this));\r\n            target.container.addEventListener(\r\n                \"DOMMouseScroll\",\r\n                scroll.bind(this),\r\n            ); // firefox\r\n            target.container.addEventListener(\"mousedown\", drag.bind(this));\r\n        } else {\r\n            target.container.classList.add(\"mirror\");\r\n        }\r\n        return target;\r\n    }\r\n\r\n    zoomTo(target, delta) {\r\n        var oldScale = this.scale;\r\n        this.scale *= Math.exp(delta);\r\n        if (this.minScale !== null)\r\n            this.scale = Math.max(this.minScale, this.scale);\r\n        if (this.maxScale !== null)\r\n            this.scale = Math.min(this.maxScale, this.scale);\r\n\r\n        var diff = { scale: this.scale / oldScale };\r\n        this.pos.x -= Math.round(\r\n            (target.x - target.x / diff.scale) * diff.scale,\r\n        );\r\n        this.pos.y -= Math.round(\r\n            (target.y - target.y / diff.scale) * diff.scale,\r\n        );\r\n\r\n        this.updateStyle(diff);\r\n        for (let itarget of this.targets) {\r\n            itarget.showMap(this.pos, this.scale);\r\n        }\r\n        return diff;\r\n    }\r\n\r\n    zoomIn() {\r\n        var tr = this.targets[0].element.getBoundingClientRect();\r\n        var target = {\r\n            x: tr.width / 2 - this.pos.x,\r\n            y: tr.height / 2 - this.pos.y,\r\n        };\r\n        this.zoomTo(target, 0.1);\r\n    }\r\n\r\n    zoomOut() {\r\n        var tr = this.targets[0].element.getBoundingClientRect();\r\n        var target = {\r\n            x: tr.width / 2 - this.pos.x,\r\n            y: tr.height / 2 - this.pos.y,\r\n        };\r\n        this.zoomTo(target, -0.1);\r\n    }\r\n\r\n    scrolled(e) {\r\n        if (this.disabled) return null;\r\n        e.preventDefault();\r\n\r\n        var delta = e.delta || e.wheelDelta;\r\n        if (delta === undefined) {\r\n            //we are on firefox\r\n            delta = -e.detail;\r\n        }\r\n        // cap the delta to [-1,1] for cross browser consistency\r\n        delta = Math.max(-1, Math.min(1, delta));\r\n        // determine the point on where the slide is zoomed in\r\n        let bounds = e.target.getBoundingClientRect();\r\n        var zoom_point = {\r\n            x: e.pageX - bounds.x - document.documentElement.scrollLeft,\r\n            y: e.pageY - bounds.y - document.documentElement.scrollTop,\r\n        };\r\n\r\n        return this.zoomTo(zoom_point, delta * this.factor);\r\n    }\r\n\r\n    drag(e) {\r\n        if (this.disabled) return null;\r\n        e.preventDefault();\r\n        var target = this.dragging;\r\n        if (!target) return null;\r\n        var ts = target.container.getBoundingClientRect();\r\n        var ter = target.element.getBoundingClientRect();\r\n        var delta,\r\n            oldPos = { x: this.pos.x, y: this.pos.y },\r\n            oldAngle = this.angle;\r\n\r\n        if (this.previousEvent) {\r\n            if (e.altKey) {\r\n                this.angle =\r\n                    (this.angle + (e.pageX - this.previousEvent.pageX)) % 360;\r\n            } else {\r\n                this.pos.x += e.pageX - this.previousEvent.pageX;\r\n                this.pos.y += e.pageY - this.previousEvent.pageY;\r\n            }\r\n        }\r\n        // Make sure the slide stays in its container area when zooming in/out\r\n        if (this.legacyModeEnabled) {\r\n            // disabled on new UI. there's a reset zoom button for this!\r\n            if (ter.width * this.scale > ts.width) {\r\n                if (this.pos.x > 0) {\r\n                    this.pos.x = 0;\r\n                }\r\n                if (this.pos.x + ter.width < ts.width) {\r\n                    this.pos.x = ts.width - ter.width;\r\n                }\r\n            } else {\r\n                if (this.pos.x < 0) {\r\n                    this.pos.x = 0;\r\n                }\r\n                if (this.pos.x + ter.width > ts.width) {\r\n                    this.pos.x = ts.width - ter.width;\r\n                }\r\n            }\r\n            if (ter.height * this.scale > ts.height) {\r\n                if (this.pos.y > 0) {\r\n                    this.pos.y = 0;\r\n                }\r\n                if (this.pos.y + ter.height < ts.height) {\r\n                    this.pos.y = ts.height - ter.height;\r\n                }\r\n            } else {\r\n                if (this.pos.y < 0) {\r\n                    this.pos.y = 0;\r\n                }\r\n                if (this.pos.y + ter.height > ts.height) {\r\n                    this.pos.y = ts.height - ter.height;\r\n                }\r\n            }\r\n        }\r\n        this.previousEvent = e;\r\n        let diff = {\r\n            x: (this.pos.x - oldPos.x) / this.scale,\r\n            y: (this.pos.y - oldPos.y) / this.scale,\r\n            angle: this.angle - oldAngle,\r\n        };\r\n        this.updateStyle(diff);\r\n        this.dragging.showMap(this.pos, this.scale);\r\n        return diff;\r\n    }\r\n\r\n    removeDrag() {\r\n        // this.targets.forEach(function(target,i) {\r\n        //     target.element.classList.remove('notransition');\r\n        // });\r\n\r\n        document.removeEventListener(\"mouseup\", this.bRemDrag);\r\n        document.removeEventListener(\"mousemove\", this.bDrag);\r\n        this.previousEvent = null;\r\n    }\r\n\r\n    draggable(event) {\r\n        if (this.disabled) return;\r\n        event.preventDefault();\r\n        this.previousEvent = event;\r\n        // this.rotationOrigin = e.point;\r\n\r\n        // set bound event handlers\r\n        this.bDrag = this.drag.bind(this);\r\n        this.bRemDrag = this.removeDrag.bind(this);\r\n        document.addEventListener(\"mousemove\", this.bDrag);\r\n        document.addEventListener(\"mouseup\", this.bRemDrag);\r\n    }\r\n\r\n    updateStyle(delta) {\r\n        this.targets.forEach(\r\n            function (target, i) {\r\n                target.update(this.pos, this.scale);\r\n                // if (this.rotationOrigin) {\r\n                //     target.rotationContainer.style.transformOrigin = this.rotationOrigin.x+'px '+this.rotationOrigin.y+'px';\r\n                //     target.rotationContainer.style.transform = 'rotate('+this.angle+'deg)';\r\n                // }\r\n            }.bind(this),\r\n        );\r\n        var event = new CustomEvent(\"wheelzoom.updated\", {\r\n            detail: { delta: delta, pos: this.pos, scale: this.scale },\r\n        });\r\n        if (this.events) this.events.dispatchEvent(event);\r\n    }\r\n\r\n    refresh() {\r\n        this.updateStyle();\r\n    }\r\n\r\n    reset() {\r\n        var oldPos = { x: this.pos.x, y: this.pos.y },\r\n            oldAngle = this.angle;\r\n        this.pos = { x: 0, y: 0 };\r\n        this.scale = this.initialScale || 1;\r\n        this.updateStyle({ x: -oldPos.x, y: -oldPos.y, scale: 1 / oldAngle });\r\n    }\r\n\r\n    disable() {\r\n        this.disabled = true;\r\n    }\r\n\r\n    enable() {\r\n        this.disabled = false;\r\n    }\r\n\r\n    destroy() {\r\n        // TODO\r\n    }\r\n}\r\n\n\n//# sourceURL=webpack://escriptorium/./src/wheelzoom.js?");

/***/ })

/******/ 	});
/************************************************************************/
/******/ 	// The module cache
/******/ 	var __webpack_module_cache__ = {};
/******/ 	
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/ 		// Check if module is in cache
/******/ 		var cachedModule = __webpack_module_cache__[moduleId];
/******/ 		if (cachedModule !== undefined) {
/******/ 			return cachedModule.exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = __webpack_module_cache__[moduleId] = {
/******/ 			// no module.id needed
/******/ 			// no module.loaded needed
/******/ 			exports: {}
/******/ 		};
/******/ 	
/******/ 		// Execute the module function
/******/ 		__webpack_modules__[moduleId](module, module.exports, __webpack_require__);
/******/ 	
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/ 	
/************************************************************************/
/******/ 	/* webpack/runtime/compat get default export */
/******/ 	(() => {
/******/ 		// getDefaultExport function for compatibility with non-harmony modules
/******/ 		__webpack_require__.n = (module) => {
/******/ 			var getter = module && module.__esModule ?
/******/ 				() => (module['default']) :
/******/ 				() => (module);
/******/ 			__webpack_require__.d(getter, { a: getter });
/******/ 			return getter;
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/define property getters */
/******/ 	(() => {
/******/ 		// define getter functions for harmony exports
/******/ 		__webpack_require__.d = (exports, definition) => {
/******/ 			for(var key in definition) {
/******/ 				if(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {
/******/ 					Object.defineProperty(exports, key, { enumerable: true, get: definition[key] });
/******/ 				}
/******/ 			}
/******/ 		};
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/hasOwnProperty shorthand */
/******/ 	(() => {
/******/ 		__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))
/******/ 	})();
/******/ 	
/******/ 	/* webpack/runtime/make namespace object */
/******/ 	(() => {
/******/ 		// define __esModule on exports
/******/ 		__webpack_require__.r = (exports) => {
/******/ 			if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 				Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 			}
/******/ 			Object.defineProperty(exports, '__esModule', { value: true });
/******/ 		};
/******/ 	})();
/******/ 	
/************************************************************************/
/******/ 	
/******/ 	// startup
/******/ 	// Load entry module and return exports
/******/ 	// This entry module can't be inlined because the eval devtool is used.
/******/ 	var __webpack_exports__ = __webpack_require__("./src/main.js");
/******/ 	
/******/ })()
;
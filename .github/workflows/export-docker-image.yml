name: Export Docker Image as Artifact

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Tag of image to export'
        required: false
        default: 'latest'

jobs:
  export-image:
    runs-on: ubuntu-latest
    
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pull image from GHCR
        run: |
          echo "ðŸ“¦ ×ž×•×¨×™×“ image ×ž-GHCR..."
          docker pull ghcr.io/${{ github.repository }}/escriptorium:${{ inputs.image_tag }}
      
      - name: Export image to tar
        run: |
          echo "ðŸ’¾ ×©×•×ž×¨ image ×›×§×•×‘×¥ tar..."
          docker save ghcr.io/${{ github.repository }}/escriptorium:${{ inputs.image_tag }} -o escriptorium-image.tar
          
          echo "ðŸ“Š ×’×•×“×œ ×”×§×•×‘×¥:"
          ls -lh escriptorium-image.tar
          
          echo "ðŸ—œï¸ ×“×•×—×¡..."
          gzip escriptorium-image.tar
          
          echo "ðŸ“Š ×’×•×“×œ ×œ××—×¨ ×“×—×™×¡×”:"
          ls -lh escriptorium-image.tar.gz
      
      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: escriptorium-docker-image
          path: escriptorium-image.tar.gz
          retention-days: 7
          compression-level: 0  # ×›×‘×¨ ×“×—×•×¡
      
      - name: Summary
        run: |
          echo "âœ… Image exported successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Artifact:** escriptorium-docker-image" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ·ï¸  **Tag:** ${{ inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ×œ×”×•×¨×“×” ×•×©×™×ž×•×©:" >> $GITHUB_STEP_SUMMARY
          echo '```powershell' >> $GITHUB_STEP_SUMMARY
          echo '# ×”×•×¨×“ ××ª escriptorium-image.tar.gz' >> $GITHUB_STEP_SUMMARY
          echo 'gunzip escriptorium-image.tar.gz' >> $GITHUB_STEP_SUMMARY
          echo 'docker load -i escriptorium-image.tar' >> $GITHUB_STEP_SUMMARY
          echo 'docker tag ghcr.io/${{ github.repository }}/escriptorium:${{ inputs.image_tag }} localhost:5001/escriptorium:${{ inputs.image_tag }}' >> $GITHUB_STEP_SUMMARY
          echo 'docker push localhost:5001/escriptorium:${{ inputs.image_tag }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

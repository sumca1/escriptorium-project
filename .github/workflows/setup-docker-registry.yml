# ========================================
# ðŸ³ Docker Registry Setup Workflow
# ========================================
# ×ž×˜×¨×”: ×”×§×ž×ª Docker Registry ×ž×§×•×ž×™
# ×ª×¨×—×™×© ×©×™×ž×•×©: ×¤×¢× ××—×ª ×œ×¤× ×™ ×‘× ×™×™×” ×¨××©×•× ×™×ª
# ×™×•×¦×¨: ×§×•×‘×¥ ×”×ª×§× ×” ×œ×”×¨×¦×” ×ž×§×•×ž×™×ª

name: Setup Docker Registry

on:
  workflow_dispatch:
    inputs:
      registry_port:
        description: 'Registry Port'
        required: false
        default: '5000'
      registry_volume:
        description: 'Registry Storage Volume'
        required: false
        default: 'docker_registry'

jobs:
  
  # ============================================
  # ðŸ“¦ Create Registry Setup Package
  # ============================================
  create-setup-package:
    name: Create Registry Setup Package
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ“ Create Registry Setup Script (PowerShell)
        run: |
          mkdir -p docker-registry-setup
          
          cat > docker-registry-setup/setup-registry.ps1 << 'PSEOF'
          # ========================================
          # ðŸ³ Docker Registry Local Setup
          # ========================================
          # ×ž×§×™× Docker Registry ×ž×§×•×ž×™ ×¢×œ ×”×ž×—×©×‘ ×©×œ×š
          # ×¤×•×¢×œ ×‘×¤×•×¨×˜ 5000 (×‘×¨×™×¨×ª ×ž×—×“×œ)
          # ×—×•×¡× ××ª NetFree ×ž×œ×—×¡×•× Docker Hub
          
          param(
              [int]$Port = 5000,
              [string]$VolumeName = "docker_registry",
              [switch]$Stop,
              [switch]$Remove
          )
          
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘  ðŸ³ Docker Registry Setup               â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor Cyan
          
          # ============================================
          # Stop & Remove
          # ============================================
          if ($Stop -or $Remove) {
              Write-Host "ðŸ›‘ ×¢×•×¦×¨ Registry...`n" -ForegroundColor Yellow
              docker stop docker-registry 2>&1 | Out-Null
              
              if ($Remove) {
                  Write-Host "ðŸ—‘ï¸ ×ž×•×—×§ Registry...`n" -ForegroundColor Yellow
                  docker rm docker-registry 2>&1 | Out-Null
                  docker volume rm $VolumeName 2>&1 | Out-Null
                  
                  Write-Host "âœ… Registry ×”×•×¡×¨!" -ForegroundColor Green
              } else {
                  Write-Host "âœ… Registry × ×¢×¦×¨!" -ForegroundColor Green
              }
              exit 0
          }
          
          # ============================================
          # Create Registry
          # ============================================
          Write-Host "ðŸ“¦ ×™×•×¦×¨ Docker Volume...`n" -ForegroundColor Cyan
          docker volume create $VolumeName
          
          Write-Host "ðŸš€ ×ž×¤×¢×™×œ Registry Container...`n" -ForegroundColor Cyan
          docker run -d `
            --name docker-registry `
            --restart=always `
            -p ${Port}:5000 `
            -v ${VolumeName}:/var/lib/registry `
            -e REGISTRY_STORAGE_DELETE_ENABLED=true `
            registry:2
          
          if ($LASTEXITCODE -eq 0) {
              Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
              Write-Host "â•‘  âœ… Registry ×¤×•×¢×œ ×‘×”×¦×œ×—×”!               â•‘" -ForegroundColor Green
              Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor Green
              
              Write-Host "ðŸ“ ×›×ª×•×‘×ª Registry:" -ForegroundColor Cyan
              Write-Host "   http://localhost:$Port`n" -ForegroundColor White
              
              Write-Host "ðŸ”§ ×”×’×“×¨×•×ª Docker:" -ForegroundColor Yellow
              Write-Host '   ×”×•×¡×£ ×œ-daemon.json:' -ForegroundColor White
              Write-Host '   {' -ForegroundColor White
              Write-Host '     "insecure-registries": ["localhost:' -NoNewline -ForegroundColor White
              Write-Host "$Port" -NoNewline -ForegroundColor Cyan
              Write-Host '"]' -ForegroundColor White
              Write-Host "   }`n" -ForegroundColor White
              
              Write-Host "ðŸ“‹ ×¤×§×•×“×•×ª ×©×™×ž×•×©×™×•×ª:" -ForegroundColor Yellow
              Write-Host "   â€¢ Tag image:    docker tag IMAGE localhost:$Port/IMAGE" -ForegroundColor White
              Write-Host "   â€¢ Push image:   docker push localhost:$Port/IMAGE" -ForegroundColor White
              Write-Host "   â€¢ Pull image:   docker pull localhost:$Port/IMAGE" -ForegroundColor White
              Write-Host "   â€¢ Stop:         .\setup-registry.ps1 -Stop" -ForegroundColor White
              Write-Host "   â€¢ Remove:       .\setup-registry.ps1 -Remove`n" -ForegroundColor White
              
              Write-Host "ðŸŽ¯ ×¦×¢×“ ×”×‘×:" -ForegroundColor Magenta
              Write-Host "   1. ×”×¤×¢×œ ×ž×—×“×© ××ª Docker Desktop" -ForegroundColor White
              Write-Host "   2. Push image: docker tag ghcr.io/sumca1/escriptorium-project:latest localhost:$Port/escriptorium:latest" -ForegroundColor White
              Write-Host "   3.             docker push localhost:$Port/escriptorium:latest`n" -ForegroundColor White
              
          } else {
              Write-Host "âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª Registry!" -ForegroundColor Red
              exit 1
          }
          PSEOF
          
          echo "âœ… Created setup-registry.ps1"
      
      - name: ðŸ“ Create Registry Setup Script (Bash)
        run: |
          cat > docker-registry-setup/setup-registry.sh << 'BASHEOF'
          #!/bin/bash
          # ========================================
          # ðŸ³ Docker Registry Local Setup
          # ========================================
          
          PORT=${1:-5000}
          VOLUME_NAME=${2:-docker_registry}
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ðŸ³ Docker Registry Setup               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo
          
          # Create volume
          echo "ðŸ“¦ Creating Docker Volume..."
          docker volume create $VOLUME_NAME
          
          # Run registry
          echo "ðŸš€ Starting Registry Container..."
          docker run -d \
            --name docker-registry \
            --restart=always \
            -p ${PORT}:5000 \
            -v ${VOLUME_NAME}:/var/lib/registry \
            -e REGISTRY_STORAGE_DELETE_ENABLED=true \
            registry:2
          
          if [ $? -eq 0 ]; then
              echo
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘  âœ… Registry Running Successfully!       â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo
              echo "ðŸ“ Registry URL: http://localhost:$PORT"
              echo
              echo "ðŸ”§ Docker Configuration:"
              echo "   Add to daemon.json:"
              echo "   {"
              echo "     \"insecure-registries\": [\"localhost:$PORT\"]"
              echo "   }"
              echo
              echo "ðŸ“‹ Useful Commands:"
              echo "   â€¢ Tag image:  docker tag IMAGE localhost:$PORT/IMAGE"
              echo "   â€¢ Push image: docker push localhost:$PORT/IMAGE"
              echo "   â€¢ Pull image: docker pull localhost:$PORT/IMAGE"
              echo
          else
              echo "âŒ Error creating Registry!"
              exit 1
          fi
          BASHEOF
          
          chmod +x docker-registry-setup/setup-registry.sh
          echo "âœ… Created setup-registry.sh"
      
      - name: ðŸ“ Create README
        run: |
          cat > docker-registry-setup/README.md << 'MDEOF'
          # ðŸ³ Docker Registry Local Setup
          
          ×§×•×‘×¥ ×”×ª×§× ×” ×œ×”×§×ž×ª Docker Registry ×ž×§×•×ž×™ ×¢×œ ×”×ž×—×©×‘ ×©×œ×š.
          
          ## ðŸ“‹ ×ž×” ×–×” ×¢×•×©×”?
          
          - ×ž×§×™× **Docker Registry ×¤×¨×˜×™** ×¢×œ ×”×ž×—×©×‘ ×”×ž×§×•×ž×™
          - ×¤×•×¢×œ ×‘×¤×•×¨×˜ **5000** (×‘×¨×™×¨×ª ×ž×—×“×œ)
          - ×ž××¤×©×¨ ×œ×š ×œ××—×¡×Ÿ ×ª×ž×•× ×•×ª Docker **×ž×§×•×ž×™×ª**
          - **×¢×•×§×£** ×—×¡×™×ž×•×ª NetFree ×©×œ Docker Hub
          
          ## ðŸš€ ×”×ª×§× ×” ×ž×”×™×¨×”
          
          ### Windows (PowerShell):
          ```powershell
          # ×”×¤×¢×œ×” ×‘×¡×™×¡×™×ª
          .\setup-registry.ps1
          
          # ×¢× ×¤×•×¨×˜ ×ž×•×ª××
          .\setup-registry.ps1 -Port 5001
          
          # ×¢×¦×™×¨×”
          .\setup-registry.ps1 -Stop
          
          # ×”×¡×¨×” ×ž×œ××”
          .\setup-registry.ps1 -Remove
          ```
          
          ### Linux/Mac (Bash):
          ```bash
          # ×”×¤×¢×œ×” ×‘×¡×™×¡×™×ª
          ./setup-registry.sh
          
          # ×¢× ×¤×•×¨×˜ ×ž×•×ª××
          ./setup-registry.sh 5001
          ```
          
          ## âš™ï¸ ×”×’×“×¨×ª Docker
          
          ×œ××—×¨ ×”×”×ª×§× ×”, **×—×•×‘×”** ×œ×”×’×“×™×¨ ××ª Docker:
          
          ### Windows:
          1. ×¤×ª×— **Docker Desktop**
          2. Settings â†’ Docker Engine
          3. ×”×•×¡×£:
          ```json
          {
            "insecure-registries": ["localhost:5000"]
          }
          ```
          4. **Restart Docker Desktop**
          
          ### Linux:
          1. ×¢×¨×•×š: `/etc/docker/daemon.json`
          2. ×”×•×¡×£:
          ```json
          {
            "insecure-registries": ["localhost:5000"]
          }
          ```
          3. ×”×¤×¢×œ ×ž×—×“×©: `sudo systemctl restart docker`
          
          ## ðŸ“¦ ×©×™×ž×•×©
          
          ### 1. Push ×ª×ž×•× ×” ×œ-Registry ×”×ž×§×•×ž×™
          ```bash
          # Tag
          docker tag ghcr.io/sumca1/escriptorium-project:latest localhost:5000/escriptorium:latest
          
          # Push
          docker push localhost:5000/escriptorium:latest
          ```
          
          ### 2. Pull ×ª×ž×•× ×” ×ž×”-Registry ×”×ž×§×•×ž×™
          ```bash
          docker pull localhost:5000/escriptorium:latest
          ```
          
          ### 3. ×©×™×ž×•×© ×‘-docker-compose
          ```yaml
          services:
            web:
              image: localhost:5000/escriptorium:latest
              # ...
          ```
          
          ## ðŸ” ×‘×“×™×§×ª ×¡×˜×˜×•×¡
          
          ```bash
          # ×‘×“×•×§ ×©×”-Registry ×¨×¥
          docker ps | grep registry
          
          # ×‘×“×•×§ ×ª×ž×•× ×•×ª ×‘-Registry
          curl http://localhost:5000/v2/_catalog
          ```
          
          ## ðŸ›‘ ×¢×¦×™×¨×” ×•×”×¡×¨×”
          
          ### ×¢×¦×™×¨×” ×–×ž× ×™×ª:
          ```powershell
          # PowerShell
          .\setup-registry.ps1 -Stop
          
          # Bash
          docker stop docker-registry
          ```
          
          ### ×”×¡×¨×” ×ž×œ××”:
          ```powershell
          # PowerShell
          .\setup-registry.ps1 -Remove
          
          # Bash
          docker rm docker-registry
          docker volume rm docker_registry
          ```
          
          ## âš ï¸ ×©×™× ×œ×‘
          
          - Registry ×–×” **×œ× ×ž××•×‘×˜×—** - ×”×©×ª×ž×© ×¨×§ **×ž×§×•×ž×™×ª**
          - **××œ ×ª×—×©×•×£** ×œ××™× ×˜×¨× ×˜ ×œ×œ× SSL/TLS
          - ×›×œ ×”×ª×ž×•× ×•×ª × ×©×ž×¨×•×ª ×‘-Docker Volume ×‘×©× `docker_registry`
          
          ## ðŸŽ¯ ×ª×¨×—×™×©×™ ×©×™×ž×•×©
          
          ### ×ª×¨×—×™×© 1: ×¤×™×ª×•×— ×ž×§×•×ž×™
          Build ×ž×§×•×ž×™ â†’ Push ×œ-Registry â†’ Test ×¢×œ ×ž×›×•× ×” ××—×¨×ª ×‘×‘×™×ª
          
          ### ×ª×¨×—×™×© 2: ×¢×§×™×¤×ª NetFree
          Build ×‘-GitHub Actions â†’ Pull ×ž-GitHub â†’ Push ×œ-Registry ×ž×§×•×ž×™ â†’ ×©×™×ž×•×© ×œ×œ× ×—×¡×™×ž×•×ª
          
          ### ×ª×¨×—×™×© 3: ×’×¨×¡××•×ª ×ž×¨×•×‘×•×ª
          ×©×ž×•×¨ ×ž×¡×¤×¨ ×’×¨×¡××•×ª ×©×œ ××•×ª×” ×ª×ž×•× ×” ×ž×§×•×ž×™×ª ×œ×‘×“×™×§×•×ª
          
          ## ðŸ“š ×ž×©××‘×™× × ×•×¡×¤×™×
          
          - [Docker Registry Documentation](https://docs.docker.com/registry/)
          - [Docker Registry API](https://docs.docker.com/registry/spec/api/)
          MDEOF
          
          echo "âœ… Created README.md"
      
      - name: ðŸ“¦ Create Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-registry-setup
          path: docker-registry-setup/
          retention-days: 90
      
      - name: ðŸ“¢ Summary
        run: |
          echo "## ðŸŽ‰ Docker Registry Setup Package Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Package Contents:" >> $GITHUB_STEP_SUMMARY
          echo "- \`setup-registry.ps1\` (Windows)" >> $GITHUB_STEP_SUMMARY
          echo "- \`setup-registry.sh\` (Linux/Mac)" >> $GITHUB_STEP_SUMMARY
          echo "- \`README.md\` (Full Instructions)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download:" >> $GITHUB_STEP_SUMMARY
          echo "Click **'docker-registry-setup'** in Artifacts below" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Quick Start:" >> $GITHUB_STEP_SUMMARY
          echo '```powershell' >> $GITHUB_STEP_SUMMARY
          echo '.\setup-registry.ps1' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

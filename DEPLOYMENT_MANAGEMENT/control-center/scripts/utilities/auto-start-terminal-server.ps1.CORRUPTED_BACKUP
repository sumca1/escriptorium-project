# ========================================# ========================================

# auto-start-terminal-server.ps1# auto-start-terminal-server.ps1

# ×¡×§×¨×™×¤×˜ ×¤×©×•×˜ ×œ×”×¤×¢×œ×ª Control Center# ×”×¤×¢×œ×ª Terminal Server + Control Center Dashboard

# ========================================# ×’×¨×¡×” ××•×ª×××ª ×œ-Control Center ×”×—×“×©!

# ========================================

param(

    [int]$Port = 3000,param(

    [switch]$Silent,    [Parameter(Mandatory=$false)]

    [switch]$NoBrowser    [int]$Port = 3001,

)    

    [Parameter(Mandatory=$false)]

$ErrorActionPreference = 'Stop'    [switch]$Silent,

    

# ×¤×•× ×§×¦×™×•×ª ×¤×©×•×˜×•×ª    [Parameter(Mandatory=$false)]

function Write-Info {    [switch]$NoBrowser

    param([string]$Message))

    if (-not $Silent) { Write-Host "â„¹ï¸  $Message" -ForegroundColor Cyan }

}$ErrorActionPreference = "Stop"



function Write-Success {# ×¦×‘×¢×™×

    param([string]$Message)function Write-Info { param($Message) if (-not $Silent) { Write-Host "â„¹ï¸  $Message" -ForegroundColor Cyan } }

    if (-not $Silent) { Write-Host "âœ… $Message" -ForegroundColor Green }function Write-Success { param($Message) if (-not $Silent) { Write-Host "âœ… $Message" -ForegroundColor Green } }

}function Write-Warning { param($Message) if (-not $Silent) { Write-Host "âš ï¸  $Message" -ForegroundColor Yellow } }



function Write-Warning {Write-Info "××¤×¢×™×œ Terminal Server + Control Center Dashboard..."

    param([string]$Message)

    if (-not $Silent) { Write-Host "âš ï¸  $Message" -ForegroundColor Yellow }# ========================================

}# ×¤×•× ×§×¦×™×”: ×‘×“×™×§×ª ×–××™× ×•×ª ×¤×•×¨×˜

# ========================================

# ××¦×™××ª × ×ª×™×‘×™×function Test-PortAvailable {

$controlCenterDir = Split-Path -Parent (Split-Path -Parent $PSScriptRoot)    param([int]$PortNumber)

$workspaceRoot = Split-Path -Parent (Split-Path -Parent (Split-Path -Parent (Split-Path -Parent $controlCenterDir)))    

$smartScriptPath = Join-Path $workspaceRoot "scripts\start-terminal-server.ps1"    try {

$dashboardPath = Join-Path $controlCenterDir "dashboard.html"        $listener = [System.Net.Sockets.TcpListener]::new([System.Net.IPAddress]::Any, $PortNumber)

        $listener.Start()

Write-Info "××¤×¢×™×œ Terminal Server + Control Center..."        $listener.Stop()

Write-Host "   ğŸ“‚ Workspace: $workspaceRoot" -ForegroundColor Gray        return $true

Write-Host "   ğŸ“œ Script: $smartScriptPath" -ForegroundColor Gray    }

Write-Host "   ğŸ“Š Dashboard: $dashboardPath" -ForegroundColor Gray    catch {

        return $false

# ×‘×“×•×§ ×©×”×¡×§×¨×™×¤×˜ ×”×¨××©×™ ×§×™×™×    }

if (-not (Test-Path $smartScriptPath)) {}

    Write-Warning "×œ× × ××¦×: $smartScriptPath"

    exit 1# ========================================

}# ×¤×•× ×§×¦×™×”: ×©×—×¨×•×¨ ×¤×•×¨×˜ (×”×¨×™×’×ª ×ª×”×œ×™×š)

# ========================================

# ×”×¤×¢×œ ××ª ×”×¡×§×¨×™×¤×˜ ×”××¨×›×–×™function Stop-ProcessOnPort {

Write-Info "××¤×¢×™×œ ×©×¨×ª ×¢×œ ×¤×•×¨×˜ $Port..."    param([int]$PortNumber)

& $smartScriptPath -Port $Port -NoBrowser    

    try {

$exitCode = $LASTEXITCODE        $connections = Get-NetTCPConnection -LocalPort $PortNumber -ErrorAction SilentlyContinue

if ($exitCode -ne 0) {        

    Write-Warning "×”×©×¨×ª × ×›×©×œ ×¢× ×§×•×“ $exitCode"        if ($connections) {

    exit $exitCode            foreach ($conn in $connections) {

}                $processId = $conn.OwningProcess

                $process = Get-Process -Id $processId -ErrorAction SilentlyContinue

Write-Success "×”×©×¨×ª ×¤×¢×™×œ!"                

                if ($process) {

# ×¤×ª×— ××ª ×”×“×©×‘×•×¨×“ ×”× ×›×•×Ÿ                    Write-Warning "âš ï¸  ×¤×•×¨×˜ $PortNumber ×ª×¤×•×¡ ×¢×œ ×™×“×™ ×ª×”×œ×™×š: $($process.ProcessName) (PID: $processId)"

if (-not $NoBrowser -and (Test-Path $dashboardPath)) {                    Write-Host "   ğŸ’€ ×¢×•×¦×¨ ××ª ×”×ª×”×œ×™×š..." -ForegroundColor Yellow

    Write-Info "×¤×•×ª×— Control Center Dashboard..."                    

    Start-Process $dashboardPath                    Stop-Process -Id $processId -Force -ErrorAction SilentlyContinue

    Write-Success "×”×“×©×‘×•×¨×“ × ×¤×ª×—!"                    Start-Sleep -Milliseconds 500

}                    

                    Write-Success "âœ… ×”×ª×”×œ×™×š × ×¢×¦×¨, ×¤×•×¨×˜ $PortNumber ×–××™×Ÿ ×¢×›×©×™×•"

Write-Host ""                    return $true

Write-Success "ğŸ‰ Control Center ××•×›×Ÿ ×œ×©×™××•×©!"                }

Write-Host ""            }

        }

exit 0    }

    catch {
        Write-Host "   â„¹ï¸  ×œ× ×”×¦×œ×—×ª×™ ×œ×–×”×•×ª ×ª×”×œ×™×š ×¢×œ ×¤×•×¨×˜ $PortNumber" -ForegroundColor Gray
    }
    
    return $false
}

# ========================================
# ×¤×•× ×§×¦×™×”: ××¦×™××ª ×¤×•×¨×˜ ×–××™×Ÿ
# ========================================
function Find-AvailablePort {
    param([int]$StartPort, [int]$MaxAttempts = 10)
    
    Write-Info "ğŸ” ××—×¤×© ×¤×•×¨×˜ ×–××™×Ÿ ×”×—×œ ×-$StartPort..."
    
    for ($i = 0; $i -lt $MaxAttempts; $i++) {
        $testPort = $StartPort + $i
        
        if (Test-PortAvailable -PortNumber $testPort) {
            Write-Success "âœ… ×¤×•×¨×˜ $testPort ×–××™×Ÿ!"
            return $testPort
        } else {
            Write-Host "   â­ï¸  ×¤×•×¨×˜ $testPort ×ª×¤×•×¡..." -ForegroundColor Gray
            
            # ×× ×–×” ×”× ×™×¡×™×•×Ÿ ×”×¨××©×•×Ÿ, × ×¡×” ×œ×©×—×¨×¨ ××ª ×”×¤×•×¨×˜
            if ($i -eq 0) {
                Write-Host "   ğŸ”§ ×× ×¡×” ×œ×©×—×¨×¨ ××ª ×”×¤×•×¨×˜..." -ForegroundColor Yellow
                $freed = Stop-ProcessOnPort -PortNumber $testPort
                
                if ($freed) {
                    # ×‘×“×•×§ ×©×•×‘ ××—×¨×™ ×©×—×¨×•×¨
                    if (Test-PortAvailable -PortNumber $testPort) {
                        Write-Success "âœ… ×¤×•×¨×˜ $testPort ×–××™×Ÿ ××—×¨×™ ×©×—×¨×•×¨!"
                        return $testPort
                    }
                }
            }
            
            Write-Host "   â­ï¸  ×× ×¡×” ×¤×•×¨×˜ ×”×‘×..." -ForegroundColor Gray
        }
    }
    
    return $null
}

# ========================================
# ×‘×“×™×§×”: ×”×× ×”×©×¨×ª ×›×‘×¨ ×¨×¥?
# ========================================
try {
    $response = Invoke-WebRequest -Uri "http://localhost:$Port/health" -Method GET -TimeoutSec 2 -ErrorAction SilentlyContinue
    if ($response.StatusCode -eq 200) {
        Write-Success "Terminal Server ×›×‘×¨ ×¤×¢×™×œ ×¢×œ ×¤×•×¨×˜ $Port!"
        
        # ×¤×ª×— ×¨×§ ××ª ×”×“×©×‘×•×¨×“
        if (-not $NoBrowser -and -not $Silent) {
            $controlCenterPath = Split-Path -Parent (Split-Path -Parent $PSScriptRoot)
            $dashboardPath = Join-Path $controlCenterPath "dashboard.html"
            
            if (Test-Path $dashboardPath) {
                Write-Info "×¤×•×ª×— ××ª Control Center Dashboard..."
                Start-Process $dashboardPath
            }
        }
        
        exit 0
    }
} catch {
    Write-Info "×”×©×¨×ª ×œ× ×¤×¢×™×œ - ××—×¤×© ×¤×•×¨×˜ ×–××™×Ÿ..."
}

# ========================================
# ×—×™×¤×•×© ×—×›× ×©×œ ×¤×•×¨×˜ ×–××™×Ÿ
# ========================================
$availablePort = Find-AvailablePort -StartPort $Port -MaxAttempts 10

if ($null -eq $availablePort) {
    Write-Warning "âŒ ×œ× × ××¦× ×¤×•×¨×˜ ×–××™×Ÿ ×‘×˜×•×•×— $Port-$($Port+9)"
    Write-Warning "× ×¡×” ×œ×¡×’×•×¨ ×ª×”×œ×™×›×™ node ×™×©× ×™× ××• ×”×©×ª××© ×‘×¤×•×¨×˜ ×’×‘×•×” ×™×•×ª×¨"
    exit 1
}

# ×¢×“×›×Ÿ ××ª ×”××©×ª× ×” ×œ×¤×•×¨×˜ ×©× ××¦×
$Port = $availablePort

# ========================================
# ×”×¤×¢×œ×ª ×©×¨×ª ×”××¡×•×£ - ×©×™×˜×” ×¤×©×•×˜×” ×•××“×•×™×§×ª
# ========================================

# × ×ª×™×‘×™×
$controlCenterPath = Split-Path -Parent (Split-Path -Parent $PSScriptRoot)
$ServerPath = Join-Path $controlCenterPath "terminal-server.js"
$DashboardPath = Join-Path $controlCenterPath "dashboard.html"
$LogPath = Join-Path $controlCenterPath "logs\terminal-server.log"

Write-Info "× ×ª×™×‘×™ ×¢×‘×•×“×”:"
Write-Info "  Control Center: $controlCenterPath"
Write-Info "  Server: $ServerPath"
Write-Info "  Dashboard: $DashboardPath"

# ×•×™×“×•×: Node.js ××•×ª×§×Ÿ
try {
    $nodeVersion = node --version
    Write-Info "Node.js ×’×¨×¡×”: $nodeVersion"
} catch {
    Write-Warning "Node.js ×œ× ××•×ª×§×Ÿ! ×™×© ×œ×”×ª×§×™×Ÿ Node.js ×ª×—×™×œ×”."
    exit 1
}

# ×•×™×“×•×: terminal-server.js ×§×™×™×
if (-not (Test-Path $ServerPath)) {
    Write-Warning "terminal-server.js ×œ× × ××¦× ×‘: $ServerPath"
    exit 1
}

# ×™×¦×™×¨×ª ×ª×™×§×™×™×ª ×œ×•×’×™×
$LogDir = Split-Path $LogPath -Parent
if (-not (Test-Path $LogDir)) {
    New-Item -ItemType Directory -Path $LogDir -Force | Out-Null
}

# ×”×¤×¢×œ×ª ×”×©×¨×ª
Write-Info "××¤×¢×™×œ Terminal Server ×‘×¨×§×¢ ×¢×œ ×¤×•×¨×˜ $Port..."

# ×”×©×ª××© ×‘-Start-Job ×•×”×¢×‘×¨ ××ª ×”×¤×•×¨×˜ ×›××¨×’×•×× ×˜ ×œnode
$job = Start-Job -ScriptBlock {
    param($ServerPath, $Port, $WorkDir)
    
    Set-Location $WorkDir
    
    # ×”×¢×‘×¨ ××ª ×”×¤×•×¨×˜ ×›××¨×’×•×× ×˜ ×¨××©×•×Ÿ ×œ-node
    & node $ServerPath $Port 2>&1
} -ArgumentList $ServerPath, $Port, $controlCenterPath

Write-Info "Job ID: $($job.Id)"

# ×©××•×¨ ××ª ×”-Job ID
$jobInfoPath = Join-Path $controlCenterPath ".terminal-server-job.txt"
$job.Id | Out-File $jobInfoPath -Encoding UTF8

# ×—×›×” ×©×”×©×¨×ª ×™×¢×œ×” (5 ×©× ×™×•×ª ××§×¡×™××•×)
Write-Info "×××ª×™×Ÿ ×©×”×©×¨×ª ×™×¢×œ×”..."
$serverStarted = $false

for ($i = 0; $i -lt 5; $i++) {
    Start-Sleep -Seconds 1
    
    try {
            $response = Invoke-WebRequest -Uri "http://localhost:$Port/health" -Method GET -TimeoutSec 2 -ErrorAction SilentlyContinue
            if ($response.StatusCode -eq 200) {
                $serverStarted = $true
                break
            }
        } catch {
            Write-Host "." -NoNewline
        }
    }
    
    Write-Host ""
    
    if ($serverStarted) {
        Write-Success "Terminal Server ×¤×¢×™×œ ×¢×œ ×¤×•×¨×˜ $Port! âœ“"
        
        # ×¢×“×›×Ÿ ××ª ×”×“×©×‘×•×¨×“ ×œ×¤×•×¨×˜ ×”× ×›×•×Ÿ
        if (Test-Path $DashboardPath) {
            Write-Info "××¢×“×›×Ÿ ××ª ×”×“×©×‘×•×¨×“ ×œ×¤×•×¨×˜ $Port..."
            try {
                $dashContent = Get-Content $DashboardPath -Raw -Encoding UTF8
                # ×¢×“×›×Ÿ ××ª ×”×¤×•×¨×˜ ×‘×§×•×“ JavaScript
                $dashContent = $dashContent -replace "localhost:\d+", "localhost:$Port"
                $dashContent = $dashContent -replace "const PORT = \d+", "const PORT = $Port"
                Set-Content $DashboardPath -Value $dashContent -Encoding UTF8 -NoNewline
                Write-Info "×”×“×©×‘×•×¨×“ ×¢×•×“×›×Ÿ!"
            } catch {
                Write-Warning "×œ× ×”×¦×œ×—×ª×™ ×œ×¢×“×›×Ÿ ××ª ×”×“×©×‘×•×¨×“: $_"
            }
        }
        
        # ×¤×ª×— ××ª ×”×“×©×‘×•×¨×“
        if (-not $NoBrowser -and (Test-Path $DashboardPath)) {
            Write-Info "×¤×•×ª×— ××ª Control Center Dashboard..."
            Start-Sleep -Seconds 1
            Start-Process $DashboardPath
            Write-Success "×”×“×©×‘×•×¨×“ × ×¤×ª×—!"
        }
        
        Write-Host ""
        Write-Success "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        Write-Success "  ğŸ‰ Control Center ××•×›×Ÿ ×œ×©×™××•×©!"
        Write-Success "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        Write-Host ""
        Write-Host "ğŸŒ ×©×¨×ª ×”××¡×•×£: http://localhost:$Port" -ForegroundColor Yellow
        Write-Host "ğŸ“Š ×“×©×‘×•×¨×“: $DashboardPath" -ForegroundColor Yellow
        Write-Host "ğŸ“‹ Job ID: $($job.Id)" -ForegroundColor Gray
        Write-Host ""
        Write-Host "ğŸ’¡ ×œ×¢×¦×™×¨×ª ×”×©×¨×ª: Stop-Job -Id $($job.Id); Remove-Job -Id $($job.Id)" -ForegroundColor Gray
        Write-Host ""
        
        exit 0
    } else {
        Write-Warning "×”×©×¨×ª ×”×ª×—×™×œ ××‘×œ ×œ× ××’×™×‘ ××—×¨×™ 5 ×©× ×™×•×ª"
        Write-Info "×‘×“×•×§ ×¤×œ×˜ Job: Receive-Job -Id $($job.Id)"
        
        # ×”×¦×’ ××ª ×¤×œ×˜ ×”-Job
        $jobOutput = Receive-Job -Id $job.Id
        if ($jobOutput) {
            Write-Host "`n×¤×œ×˜ ×”×©×¨×ª:" -ForegroundColor Yellow
            $jobOutput | ForEach-Object { Write-Host "  $_" }
        }
        
        exit 1
    }

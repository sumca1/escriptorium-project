// ========================================
// ××•×“×•×œ ×“×•×§×¨ (Docker Module)
// ========================================

import dataLoader from './data-loader.js';
import terminalConfig from './terminal-config.js';

export async function init() {
    console.log('×××ª×—×œ ××•×“×•×œ ×“×•×§×¨ (Initializing Docker Module)');
    await renderDocker();
}

async function renderDocker() {
    const container = document.getElementById('docker-content');
    
    // ×˜×¢×™× ×ª × ×ª×•× ×™ Docker ×××™×ª×™×™×
    const dockerStatus = await dataLoader.getDockerStatus();
    const runningCount = dockerStatus.containers.filter(c => c.isRunning).length;
    const totalCount = dockerStatus.containers.length;
    
    container.innerHTML = `
        <div class="stats-grid" style="margin-bottom: 2rem;">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">××›×•×œ×•×ª ×¤×¢×™×œ×•×ª (Running Containers)</span>
                    <div class="stat-icon" style="background: rgba(5, 150, 105, 0.1); color: var(--success-green);">
                        ğŸ³
                    </div>
                </div>
                <div class="stat-value">${runningCount}/${totalCount}</div>
                <div class="stat-change ${runningCount === totalCount ? 'positive' : ''}">
                    <span>${runningCount === totalCount ? '×”×›×œ ×¤×•×¢×œ' : '×—×œ×§×Ÿ ×›×‘×•×™×•×ª'}</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">×¢×“×›×•×Ÿ ××—×¨×•×Ÿ (Last Check)</span>
                    <div class="stat-icon" style="background: rgba(217, 119, 6, 0.1); color: var(--warning-orange);">
                        ï¿½
                    </div>
                </div>
                <div class="stat-value">×¢×›×©×™×•</div>
                <div class="stat-change">
                    <span>×¨×¢× ×Ÿ ×œ× ×ª×•× ×™× ×—×“×©×™×</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">×¡×˜×˜×•×¡ ×›×œ×œ×™ (Overall Status)</span>
                    <div class="stat-icon" style="background: rgba(59, 130, 246, 0.1); color: var(--primary-blue-light);">
                        âš¡
                    </div>
                </div>
                <div class="stat-value">${runningCount === totalCount ? 'âœ… ×ª×§×™×Ÿ' : 'âš ï¸ ×—×œ×§×™'}</div>
                <div class="stat-change ${runningCount === totalCount ? 'positive' : ''}">
                    <span>${Math.round((runningCount / totalCount) * 100)}% ×–××™× ×•×ª</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">×¤×¢×•×œ×•×ª (Quick Actions)</span>
                    <div class="stat-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                        ğŸ›ï¸
                    </div>
                </div>
                <div class="stat-value">
                    <button class="btn btn-sm btn-success" onclick="window.dockerRefresh()" style="font-size: 0.875rem;">
                        ğŸ”„ ×¨×¢× ×Ÿ
                    </button>
                </div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 1.5rem;">
            <div class="card-header">
                <h3 class="card-title">×¤×¢×•×œ×•×ª ××”×™×¨×•×ª (Quick Actions)</h3>
            </div>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; padding: 0 0.5rem 0.5rem;">
                <button class="btn btn-success" onclick="window.dockerAction('ps')">
                    ğŸ“‹ ×”×¦×’ ××›×•×œ×•×ª (List Containers)
                </button>
                <button class="btn btn-warning" onclick="window.dockerAction('restart')">
                    ğŸ”„ ××ª×—×œ ×”×›×œ (Restart All)
                </button>
                <button class="btn btn-primary" onclick="window.dockerAction('logs-web')">
                    ğŸ“ ×œ×•×’×™× Web
                </button>
                <button class="btn btn-info" onclick="window.dockerAction('stats')">
                    ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª (Stats)
                </button>
            </div>
        </div>

        <!-- ×˜×‘×œ×ª ××›×•×œ×•×ª -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">×¨×©×™××ª ××›×•×œ×•×ª (Containers List)</h3>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>×©× ××›×•×œ×” (Container Name)</th>
                            <th>××¦×‘ (Status)</th>
                            <th>×¤×¢×•×œ×•×ª (Actions)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${dockerStatus.containers.map(container => `
                            <tr>
                                <td><strong>${container.name}</strong></td>
                                <td>
                                    <span class="status-badge ${container.isRunning ? 'status-success' : 'status-danger'}">
                                        ${container.isRunning ? 'âœ… ×¤×•×¢×œ (Running)' : 'âŒ ×›×‘×•×™ (Stopped)'}
                                    </span>
                                    <br>
                                    <small style="color: var(--text-secondary);">${container.status}</small>
                                </td>
                                <td>
                                    ${container.isRunning ? `
                                        <button class="btn btn-sm btn-warning" onclick="window.dockerContainerAction('${container.name}', 'restart')">
                                            ğŸ”„ ××ª×—×œ
                                        </button>
                                        <button class="btn btn-sm btn-primary" onclick="window.dockerContainerAction('${container.name}', 'logs')">
                                            ğŸ“ ×œ×•×’×™×
                                        </button>
                                    ` : `
                                        <button class="btn btn-sm btn-success" onclick="window.dockerContainerAction('${container.name}', 'start')">
                                            â–¶ï¸ ×”×¤×¢×œ
                                        </button>
                                    `}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    // ×¤×•× ×§×¦×™×•×ª ×’×œ×•×‘×œ×™×•×ª
    window.dockerRefresh = async () => {
        dataLoader.clearCache();
        await renderDocker();
        alert('âœ… × ×ª×•× ×™ Docker ×¢×•×“×›× ×•!');
    };
    
    window.dockerAction = async (action) => {
        const commands = {
            'ps': 'docker ps -a',
            'restart': 'docker-compose restart',
            'logs-web': 'docker-compose logs web --tail 50',
            'stats': 'docker stats --no-stream'
        };
        
        const command = commands[action];
        if (!command) return;
        
        try {
            const result = await terminalConfig.executeCommand(command);
            alert(`âœ… ×ª×•×¦××”:\n\n${result.output || result.error || '×”×¤×¢×•×œ×” ×”×¡×ª×™×™××”'}`);
        } catch (error) {
            alert(`âŒ ×©×’×™××”: ${error.message}`);
        }
    };
    
    window.dockerContainerAction = async (containerName, action) => {
        const commands = {
            'restart': `docker restart ${containerName}`,
            'start': `docker start ${containerName}`,
            'logs': `docker logs ${containerName} --tail 50`
        };
        
        const command = commands[action];
        if (!command) return;
        
        try {
            const result = await terminalConfig.executeCommand(command);
            alert(`âœ… ×¤×¢×•×œ×” ×”×¦×œ×™×—×”!\n\n${result.output || '×”×•×©×œ× ×‘×”×¦×œ×—×”'}`);
            await window.dockerRefresh();
        } catch (error) {
            alert(`âŒ ×©×’×™××”: ${error.message}`);
        }
    };
}
        <!-- ×˜×‘×œ×ª ××›×•×œ×•×ª -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">××›×•×œ×•×ª ×¤×¢×™×œ×•×ª (Active Containers)</h3>
                <button class="btn btn-primary" onclick="refreshContainers()">
                    ğŸ”„ ×¨×¢× ×Ÿ (Refresh)
                </button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>×©× (Name)</th>
                            <th>×ª××•× ×” (Image)</th>
                            <th>××¦×‘ (Status)</th>
                            <th>×¤×•×¨×˜×™× (Ports)</th>
                            <th>×–×™×›×¨×•×Ÿ (Memory)</th>
                            <th>CPU</th>
                            <th>×¤×¢×•×œ×•×ª (Actions)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>escriptorium-web</strong></td>
                            <td>escriptorium:latest</td>
                            <td><span class="status-badge status-success">Running</span></td>
                            <td>8080:80</td>
                            <td>512 MB</td>
                            <td>12%</td>
                            <td>
                                <button class="btn btn-warning" style="padding: 0.375rem 0.75rem;" onclick="restartContainer('web')">
                                    ğŸ”„ ××ª×—×œ
                                </button>
                                <button class="btn btn-danger" style="padding: 0.375rem 0.75rem;" onclick="stopContainer('web')">
                                    â¹ï¸ ×¢×¦×•×¨
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>escriptorium-db</strong></td>
                            <td>postgres:14</td>
                            <td><span class="status-badge status-success">Running</span></td>
                            <td>5432:5432</td>
                            <td>1.2 GB</td>
                            <td>8%</td>
                            <td>
                                <button class="btn btn-warning" style="padding: 0.375rem 0.75rem;" onclick="restartContainer('db')">
                                    ğŸ”„ ××ª×—×œ
                                </button>
                                <button class="btn btn-danger" style="padding: 0.375rem 0.75rem;" onclick="stopContainer('db')">
                                    â¹ï¸ ×¢×¦×•×¨
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>escriptorium-redis</strong></td>
                            <td>redis:7-alpine</td>
                            <td><span class="status-badge status-success">Running</span></td>
                            <td>6379:6379</td>
                            <td>128 MB</td>
                            <td>3%</td>
                            <td>
                                <button class="btn btn-warning" style="padding: 0.375rem 0.75rem;" onclick="restartContainer('redis')">
                                    ğŸ”„ ××ª×—×œ
                                </button>
                                <button class="btn btn-danger" style="padding: 0.375rem 0.75rem;" onclick="stopContainer('redis')">
                                    â¹ï¸ ×¢×¦×•×¨
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>escriptorium-nginx</strong></td>
                            <td>nginx:alpine</td>
                            <td><span class="status-badge status-success">Running</span></td>
                            <td>80:80, 443:443</td>
                            <td>256 MB</td>
                            <td>5%</td>
                            <td>
                                <button class="btn btn-warning" style="padding: 0.375rem 0.75rem;" onclick="restartContainer('nginx')">
                                    ğŸ”„ ××ª×—×œ
                                </button>
                                <button class="btn btn-danger" style="padding: 0.375rem 0.75rem;" onclick="stopContainer('nginx')">
                                    â¹ï¸ ×¢×¦×•×¨
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>escriptorium-celery</strong></td>
                            <td>escriptorium:latest</td>
                            <td><span class="status-badge status-success">Running</span></td>
                            <td>--</td>
                            <td>384 MB</td>
                            <td>7%</td>
                            <td>
                                <button class="btn btn-warning" style="padding: 0.375rem 0.75rem;" onclick="restartContainer('celery')">
                                    ğŸ”„ ××ª×—×œ
                                </button>
                                <button class="btn btn-danger" style="padding: 0.375rem 0.75rem;" onclick="stopContainer('celery')">
                                    â¹ï¸ ×¢×¦×•×¨
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ×ª××•× ×•×ª ×–××™× ×•×ª -->
        <div class="card" style="margin-top: 2rem;">
            <div class="card-header">
                <h3 class="card-title">×ª××•× ×•×ª ×“×•×§×¨ (Docker Images)</h3>
                <button class="btn btn-secondary" onclick="pullImages()">
                    â¬‡ï¸ ××©×•×š ×¢×“×›×•× ×™× (Pull Updates)
                </button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>×ª××•× ×” (Image)</th>
                            <th>×ª×’ (Tag)</th>
                            <th>×’×•×“×œ (Size)</th>
                            <th>× ×•×¦×¨ (Created)</th>
                            <th>×¤×¢×•×œ×•×ª (Actions)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>escriptorium</strong></td>
                            <td>latest</td>
                            <td>2.4 GB</td>
                            <td>×œ×¤× ×™ 2 ×©×¢×•×ª</td>
                            <td>
                                <button class="btn btn-primary" style="padding: 0.375rem 0.75rem;" onclick="buildImage('escriptorium')">
                                    ğŸ—ï¸ ×‘× ×” ××—×“×©
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>postgres</strong></td>
                            <td>14</td>
                            <td>376 MB</td>
                            <td>×œ×¤× ×™ ×©×‘×•×¢</td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 0.375rem 0.75rem;" onclick="removeImage('postgres')">
                                    ğŸ—‘ï¸ ×”×¡×¨
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>redis</strong></td>
                            <td>7-alpine</td>
                            <td>32 MB</td>
                            <td>×œ×¤× ×™ ×©×‘×•×¢×™×™×</td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 0.375rem 0.75rem;" onclick="removeImage('redis')">
                                    ğŸ—‘ï¸ ×”×¡×¨
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>nginx</strong></td>
                            <td>alpine</td>
                            <td>24 MB</td>
                            <td>×œ×¤× ×™ ×—×•×“×©</td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 0.375rem 0.75rem;" onclick="removeImage('nginx')">
                                    ğŸ—‘ï¸ ×”×¡×¨
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// ×¤×•× ×§×¦×™×•×ª × ×™×”×•×œ ×“×•×§×¨
window.dockerAction = function(action) {
    console.log(`××‘×¦×¢ ×¤×¢×•×œ×ª ×“×•×§×¨: ${action}`);
    alert(`××‘×¦×¢: ${action} (Executing Docker action: ${action})`);
};

window.refreshContainers = function() {
    console.log('××¨×¢× ×Ÿ ×¨×©×™××ª ××›×•×œ×•×ª...');
    alert('××¨×¢× ×Ÿ ××›×•×œ×•×ª (Refreshing containers list)');
};

window.restartContainer = function(container) {
    console.log(`×××ª×—×œ ××›×•×œ×”: ${container}`);
    alert(`×××ª×—×œ ××›×•×œ×”: ${container} (Restarting container: ${container})`);
};

window.stopContainer = function(container) {
    console.log(`×¢×•×¦×¨ ××›×•×œ×”: ${container}`);
    if (confirm(`×”×× ×œ×¢×¦×•×¨ ××›×•×œ×”: ${container}? (Stop container: ${container}?)`)) {
        alert(`××›×•×œ×” ${container} × ×¢×¦×¨×” (Container ${container} stopped)`);
    }
};

window.buildImage = function(image) {
    console.log(`×‘×•× ×” ×ª××•× ×”: ${image}`);
    alert(`×‘×•× ×” ×ª××•× ×”: ${image} (Building image: ${image})`);
};

window.removeImage = function(image) {
    console.log(`××¡×™×¨ ×ª××•× ×”: ${image}`);
    if (confirm(`×”×× ×œ×”×¡×™×¨ ×ª××•× ×”: ${image}? (Remove image: ${image}?)`)) {
        alert(`×ª××•× ×” ${image} ×”×•×¡×¨×” (Image ${image} removed)`);
    }
};

window.pullImages = function() {
    console.log('××©×š ×¢×“×›×•× ×™ ×ª××•× ×•×ª...');
    alert('××©×š ×¢×“×›×•× ×™× ×œ×›×œ ×”×ª××•× ×•×ª (Pulling image updates)');
};
